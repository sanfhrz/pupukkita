<?php
session_start();
require_once '../includes/config.php';

// Cek apakah user adalah admin
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
    header('Location: ../login.php');
    exit();
}

$message = '';
$message_type = '';

// Handle POST requests
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['action'])) {
        switch ($_POST['action']) {
            case 'add_product':
                $nama_produk = trim($_POST['nama_produk']);
                $kategori_id = !empty($_POST['kategori_id']) ? (int)$_POST['kategori_id'] : null;
                $brand = trim($_POST['brand']);
                $jenis_pupuk = $_POST['jenis_pupuk'];
                $berat = trim($_POST['berat']);
                $harga = (float)$_POST['harga'];
                $stok = (int)$_POST['stok'];
                $deskripsi = trim($_POST['deskripsi']);
                $manfaat = trim($_POST['manfaat']);
                $cara_pakai = trim($_POST['cara_pakai']);
                $status = $_POST['status'];
                $is_featured = isset($_POST['is_featured']) ? 1 : 0;

                // Handle image upload untuk ADD PRODUCT
                $gambar = null;
                if (isset($_FILES['gambar']) && $_FILES['gambar']['error'] == 0) {
                    $allowed = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                    $filename = $_FILES['gambar']['name'];
                    $filetype = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

                    if (in_array($filetype, $allowed)) {
                        $newname = 'product_' . time() . '_' . uniqid() . '.' . $filetype;

                        $upload_dir = '../assets/img/pupuk/';
                        if (!file_exists($upload_dir)) {
                            mkdir($upload_dir, 0777, true);
                        }

                        $upload_path = $upload_dir . $newname;

                        if (move_uploaded_file($_FILES['gambar']['tmp_name'], $upload_path)) {
                            $gambar = $newname;
                            resizeImage($upload_path, 800, 600);
                        } else {
                            $message = 'Gagal upload gambar!';
                            $message_type = 'danger';
                        }
                    } else {
                        $message = 'Format file tidak didukung. Gunakan: JPG, PNG, GIF, WEBP';
                        $message_type = 'danger';
                    }
                }

                try {
                    $stmt = $pdo->prepare("INSERT INTO produk (nama_produk, kategori_id, brand, jenis_pupuk, berat, harga, stok, deskripsi, manfaat, cara_pakai, gambar, status, is_featured) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
                    $stmt->execute([$nama_produk, $kategori_id, $brand, $jenis_pupuk, $berat, $harga, $stok, $deskripsi, $manfaat, $cara_pakai, $gambar, $status, $is_featured]);

                    $message = 'Produk berhasil ditambahkan!';
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;

            case 'update_product':
                $id = (int)$_POST['id'];
                $nama_produk = trim($_POST['nama_produk']);
                $kategori_id = !empty($_POST['kategori_id']) ? (int)$_POST['kategori_id'] : null;
                $brand = trim($_POST['brand']);
                $jenis_pupuk = $_POST['jenis_pupuk'];
                $berat = trim($_POST['berat']);
                $harga = (float)$_POST['harga'];
                $stok = (int)$_POST['stok'];
                $deskripsi = trim($_POST['deskripsi']);
                $manfaat = trim($_POST['manfaat']);
                $cara_pakai = trim($_POST['cara_pakai']);
                $status = $_POST['status'];
                $is_featured = isset($_POST['is_featured']) ? 1 : 0;

                // Get current product data
                $stmt = $pdo->prepare("SELECT gambar FROM produk WHERE id = ?");
                $stmt->execute([$id]);
                $current_product = $stmt->fetch();
                $gambar = $current_product['gambar'];

                // Handle image upload untuk UPDATE PRODUCT
                if (isset($_FILES['gambar']) && $_FILES['gambar']['error'] == 0) {
                    $allowed = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                    $filename = $_FILES['gambar']['name'];
                    $filetype = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

                    if (in_array($filetype, $allowed)) {
                        $newname = 'product_' . time() . '_' . uniqid() . '.' . $filetype;
                        $upload_path = '../assets/img/pupuk/' . $newname;

                        if (move_uploaded_file($_FILES['gambar']['tmp_name'], $upload_path)) {
                            // Delete old image
                            if ($gambar && file_exists('../assets/img/pupuk/' . $gambar)) {
                                unlink('../assets/img/pupuk/' . $gambar);
                            }

                            $gambar = $newname;
                            resizeImage($upload_path, 800, 600);
                        }
                    }
                }

                try {
                    $stmt = $pdo->prepare("UPDATE produk SET nama_produk = ?, kategori_id = ?, brand = ?, jenis_pupuk = ?, berat = ?, harga = ?, stok = ?, deskripsi = ?, manfaat = ?, cara_pakai = ?, gambar = ?, status = ?, is_featured = ? WHERE id = ?");
                    $stmt->execute([$nama_produk, $kategori_id, $brand, $jenis_pupuk, $berat, $harga, $stok, $deskripsi, $manfaat, $cara_pakai, $gambar, $status, $is_featured, $id]);

                    $message = 'Produk berhasil diupdate!';
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;

            case 'delete_product':
                $id = (int)$_POST['id'];

                try {
                    // Get product image
                    $stmt = $pdo->prepare("SELECT gambar FROM produk WHERE id = ?");
                    $stmt->execute([$id]);
                    $product = $stmt->fetch();

                    // Delete product
                    $stmt = $pdo->prepare("DELETE FROM produk WHERE id = ?");
                    $stmt->execute([$id]);

                    // Delete image file
                    if ($product && $product['gambar'] && file_exists('../assets/img/pupuk/' . $product['gambar'])) {
                        unlink('../assets/img/pupuk/' . $product['gambar']);
                    }

                    $message = 'Produk berhasil dihapus!';
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;

            case 'toggle_status':
                $id = (int)$_POST['id'];
                $current_status = $_POST['current_status'];
                $new_status = $current_status === 'active' ? 'inactive' : 'active';

                try {
                    $stmt = $pdo->prepare("UPDATE produk SET status = ? WHERE id = ?");
                    $stmt->execute([$new_status, $id]);

                    $message = "Status produk berhasil diubah menjadi $new_status!";
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;

            case 'toggle_featured':
                $id = (int)$_POST['id'];
                $current_featured = (int)$_POST['current_featured'];
                $new_featured = $current_featured ? 0 : 1;

                try {
                    $stmt = $pdo->prepare("UPDATE produk SET is_featured = ? WHERE id = ?");
                    $stmt->execute([$new_featured, $id]);

                    $status_text = $new_featured ? 'featured' : 'tidak featured';
                    $message = "Produk berhasil diubah menjadi $status_text!";
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;
        }
    }
}

// Get categories for dropdown
$categories_stmt = $pdo->query("SELECT * FROM kategori ORDER BY nama_kategori");
$categories = $categories_stmt->fetchAll();

// Get filters
$search = $_GET['search'] ?? '';
$jenis_filter = $_GET['jenis'] ?? '';
$status_filter = $_GET['status'] ?? '';
$kategori_filter = $_GET['kategori'] ?? '';
$featured_filter = $_GET['featured'] ?? '';
$stok_rendah = $_GET['stok_rendah'] ?? '';
$sort = $_GET['sort'] ?? 'created_at';
$order = $_GET['order'] ?? 'DESC';

// Build query
$sql = "SELECT p.*, k.nama_kategori 
        FROM produk p 
        LEFT JOIN kategori k ON p.kategori_id = k.id 
        WHERE 1=1";

$params = [];

if ($search) {
    $sql .= " AND (p.nama_produk LIKE ? OR p.brand LIKE ? OR k.nama_kategori LIKE ?)";
    $search_param = "%$search%";
    $params[] = $search_param;
    $params[] = $search_param;
    $params[] = $search_param;
}

if ($jenis_filter) {
    $sql .= " AND p.jenis_pupuk = ?";
    $params[] = $jenis_filter;
}

if ($status_filter) {
    $sql .= " AND p.status = ?";
    $params[] = $status_filter;
}

if ($kategori_filter) {
    $sql .= " AND p.kategori_id = ?";
    $params[] = $kategori_filter;
}

if ($featured_filter !== '') {
    $sql .= " AND p.is_featured = ?";
    $params[] = (int)$featured_filter;
}

if ($stok_rendah) {
    $sql .= " AND p.stok < 10";
}

$sql .= " ORDER BY p.$sort $order";

$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$products = $stmt->fetchAll();

// Get product statistics
try {
    $stats = [
        'total' => 0,
        'active' => 0,
        'inactive' => 0,
        'featured' => 0,
        'low_stock' => 0,
        'out_of_stock' => 0
    ];
    
    $stmt = $pdo->query("SELECT 
        COUNT(*) as total,
        SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active,
        SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive,
        SUM(CASE WHEN is_featured = 1 THEN 1 ELSE 0 END) as featured,
        SUM(CASE WHEN stok < 10 AND stok > 0 THEN 1 ELSE 0 END) as low_stock,
        SUM(CASE WHEN stok = 0 THEN 1 ELSE 0 END) as out_of_stock
        FROM produk");
    
    $result = $stmt->fetch();
    if ($result) {
        $stats = $result;
    }
} catch (PDOException $e) {
    $stats = ['total' => 0, 'active' => 0, 'inactive' => 0, 'featured' => 0, 'low_stock' => 0, 'out_of_stock' => 0];
}

// Function untuk resize image
function resizeImage($file, $maxWidth, $maxHeight)
{
    $info = getimagesize($file);
    if (!$info) return false;

    $width = $info[0];
    $height = $info[1];
    $type = $info[2];

    // Calculate new dimensions
    $ratio = min($maxWidth / $width, $maxHeight / $height);
    $newWidth = round($width * $ratio);
    $newHeight = round($height * $ratio);

    // Create image resource
    switch ($type) {
        case IMAGETYPE_JPEG:
            $source = imagecreatefromjpeg($file);
            break;
        case IMAGETYPE_PNG:
            $source = imagecreatefrompng($file);
            break;
        case IMAGETYPE_GIF:
            $source = imagecreatefromgif($file);
            break;
        case IMAGETYPE_WEBP:
            $source = imagecreatefromwebp($file);
            break;
        default:
            return false;
    }

    if (!$source) return false;

    // Create new image
    $destination = imagecreatetruecolor($newWidth, $newHeight);

    // Preserve transparency
    if ($type == IMAGETYPE_PNG || $type == IMAGETYPE_GIF) {
        imagealphablending($destination, false);
        imagesavealpha($destination, true);
        $transparent = imagecolorallocatealpha($destination, 255, 255, 255, 127);
        imagefilledrectangle($destination, 0, 0, $newWidth, $newHeight, $transparent);
    }

    // Resize
    imagecopyresampled($destination, $source, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);

    // Save
    switch ($type) {
        case IMAGETYPE_JPEG:
            imagejpeg($destination, $file, 90);
            break;
        case IMAGETYPE_PNG:
            imagepng($destination, $file, 9);
            break;
        case IMAGETYPE_GIF:
            imagegif($destination, $file);
            break;
        case IMAGETYPE_WEBP:
                        imagewebp($destination, $file, 90);
            break;
    }

    // Clean up
    imagedestroy($source);
    imagedestroy($destination);

    return true;
}
?>

<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Produk - Admin Sahabat Tani</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .sidebar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-brand {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            text-decoration: none;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 0;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
        }

        .main-content {
            margin-left: 250px;
            padding: 2rem;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .stats-card.total { border-left-color: #6f42c1; }
        .stats-card.active { border-left-color: #28a745; }
        .stats-card.inactive { border-left-color: #6c757d; }
        .stats-card.featured { border-left-color: #ffc107; }
        .stats-card.low-stock { border-left-color: #fd7e14; }
        .stats-card.out-of-stock { border-left-color: #dc3545; }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
        }

        .table th {
            border-top: none;
            border-bottom: 2px solid #e9ecef;
            color: #495057;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f8f9fa;
        }

        .table td {
            vertical-align: middle;
            padding: 1rem 0.75rem;
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
            transform: translateY(-1px);
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #e9ecef;
            padding: 0.75rem 1rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .product-image:hover {
            transform: scale(1.1);
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .action-buttons {
            white-space: nowrap;
        }

        .action-buttons .btn {
            margin: 1px;
        }

        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .table-responsive {
                font-size: 0.85rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.php" class="sidebar-brand">
                <i class="fas fa-leaf me-2"></i>
                Sahabat Tani
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="dashboard.php" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="orders.php" class="nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    Kelola Pesanan
                </a>
            </div>
            <div class="nav-item">
                <a href="products.php" class="nav-link active">
                    <i class="fas fa-box"></i>
                    Kelola Produk
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="alert('Coming Soon!')">
                    <i class="fas fa-tags"></i>
                    Kode Promo
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="alert('Coming Soon!')">
                    <i class="fas fa-chart-bar"></i>
                    Laporan
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="alert('Coming Soon!')">
                    <i class="fas fa-cog"></i>
                    Pengaturan
                </a>
            </div>
            <div class="nav-item mt-4">
                <a href="../logout.php" class="nav-link text-danger">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header animate-fade-in">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        <i class="fas fa-box me-3"></i>
                        Kelola Produk
                    </h2>
                    <p class="text-muted mb-0">Kelola semua produk pupuk dan pestisida</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="exportProducts()">
                        <i class="fas fa-download me-2"></i>
                        Export
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus me-2"></i>
                        Tambah Produk
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <?php if ($message): ?>
            <div class="alert alert-<?php echo $message_type; ?> alert-dismissible fade show" role="alert">
                <i class="fas fa-<?php echo $message_type == 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2"></i>
                <?php echo htmlspecialchars($message); ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <!-- Statistics -->
        <div class="stats-grid animate-fade-in">
            <div class="stats-card total">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1"><?php echo $stats['total']; ?></h3>
                        <p class="text-muted mb-0">Total Produk</p>
                    </div>
                    <div class="text-purple">
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>

            <div class="stats-card active">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1"><?php echo $stats['active']; ?></h3>
                        <p class="text-muted mb-0">Produk Aktif</p>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>

            <div class="stats-card featured">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1"><?php echo $stats['featured']; ?></h3>
                        <p class="text-muted mb-0">Featured</p>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                </div>
            </div>

            <div class="stats-card low-stock">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1"><?php echo $stats['low_stock']; ?></h3>
                        <p class="text-muted mb-0">Stok Rendah</p>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>

            <div class="stats-card out-of-stock">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1"><?php echo $stats['out_of_stock']; ?></h3>
                        <p class="text-muted mb-0">Stok Habis</p>
                    </div>
                    <div class="text-danger">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>

            <div class="stats-card inactive">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1"><?php echo $stats['inactive']; ?></h3>
                        <p class="text-muted mb-0">Tidak Aktif</p>
                    </div>
                    <div class="text-secondary">
                        <i class="fas fa-pause-circle fa-2x"></i>
                    </div
                                    </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section animate-fade-in">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Cari Produk</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" name="search" 
                               value="<?php echo htmlspecialchars($search); ?>" 
                               placeholder="Nama produk, brand...">
                    </div>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Jenis Pupuk</label>
                    <select class="form-select" name="jenis">
                        <option value="">Semua Jenis</option>
                        <option value="organik" <?php echo $jenis_filter === 'organik' ? 'selected' : ''; ?>>Organik</option>
                        <option value="anorganik" <?php echo $jenis_filter === 'anorganik' ? 'selected' : ''; ?>>Anorganik</option>
                        <option value="hayati" <?php echo $jenis_filter === 'hayati' ? 'selected' : ''; ?>>Hayati</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="">Semua Status</option>
                        <option value="active" <?php echo $status_filter === 'active' ? 'selected' : ''; ?>>Active</option>
                        <option value="inactive" <?php echo $status_filter === 'inactive' ? 'selected' : ''; ?>>Inactive</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Kategori</label>
                    <select class="form-select" name="kategori">
                        <option value="">Semua Kategori</option>
                        <?php foreach ($categories as $cat): ?>
                            <option value="<?php echo $cat['id']; ?>" <?php echo $kategori_filter == $cat['id'] ? 'selected' : ''; ?>>
                                <?php echo htmlspecialchars($cat['nama_kategori']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Featured</label>
                    <select class="form-select" name="featured">
                        <option value="">Semua</option>
                        <option value="1" <?php echo $featured_filter === '1' ? 'selected' : ''; ?>>Featured</option>
                        <option value="0" <?php echo $featured_filter === '0' ? 'selected' : ''; ?>>Not Featured</option>
                    </select>
                </div>

                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-outline-primary d-block w-100">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </form>

            <div class="mt-3">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="?" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-refresh me-1"></i>
                        Reset Filter
                    </a>
                    <a href="?stok_rendah=1" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Stok Rendah
                    </a>
                    <a href="?featured=1" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-star me-1"></i>
                        Featured
                    </a>
                    <span class="badge bg-info fs-6">
                        Total: <?php echo count($products); ?> produk
                    </span>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card animate-fade-in">
            <div class="card-header">
                <i class="fas fa-list me-2"></i>
                Daftar Produk
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Gambar</th>
                                <th>Produk</th>
                                <th>Kategori</th>
                                <th>Jenis</th>
                                <th>Harga</th>
                                <th>Stok</th>
                                <th>Status</th>
                                <th>Featured</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($products)): ?>
                                <tr>
                                    <td colspan="9" class="text-center py-5 text-muted">
                                        <i class="fas fa-box-open fa-3x mb-3 d-block"></i>
                                        <h5>Belum ada produk</h5>
                                        <p>Produk akan muncul di sini setelah ditambahkan</p>
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php foreach ($products as $product): ?>
                                    <tr>
                                        <td>
                                            <?php if ($product['gambar']): ?>
                                                <img src="../assets/img/pupuk/<?php echo htmlspecialchars($product['gambar']); ?>"
                                                     alt="<?php echo htmlspecialchars($product['nama_produk']); ?>"
                                                     class="product-image"
                                                     onclick="zoomImage('../assets/img/pupuk/<?php echo htmlspecialchars($product['gambar']); ?>', '<?php echo htmlspecialchars($product['nama_produk']); ?>')">
                                            <?php else: ?>
                                                <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <div>
                                                <h6 class="mb-1"><?php echo htmlspecialchars($product['nama_produk']); ?></h6>
                                                <small class="text-muted">
                                                    <?php echo htmlspecialchars($product['brand'] ?? 'No Brand'); ?> | 
                                                    <?php echo htmlspecialchars($product['berat']); ?>
                                                    <br>ID: <?php echo $product['id']; ?>
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                <?php echo htmlspecialchars($product['nama_kategori'] ?? 'Tidak ada'); ?>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-<?php echo $product['jenis_pupuk'] === 'organik' ? 'success' : ($product['jenis_pupuk'] === 'anorganik' ? 'primary' : 'info'); ?>">
                                                <?php echo ucfirst($product['jenis_pupuk']); ?>
                                            </span>
                                        </td>
                                        <td>
                                            <strong>Rp <?php echo number_format($product['harga'], 0, ',', '.'); ?></strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-<?php echo $product['stok'] == 0 ? 'danger' : ($product['stok'] < 10 ? 'warning' : 'success'); ?>">
                                                <?php echo $product['stok']; ?>
                                            </span>
                                        </td>
                                        <td>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_status">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <input type="hidden" name="current_status" value="<?php echo $product['status']; ?>">
                                                <button type="submit" class="btn btn-sm btn-<?php echo $product['status'] === 'active' ? 'success' : 'secondary'; ?>"
                                                        onclick="return confirm('Yakin ingin mengubah status produk ini?')">
                                                    <?php echo $product['status'] === 'active' ? 'Active' : 'Inactive'; ?>
                                                </button>
                                            </form>
                                        </td>
                                        <td>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_featured">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <input type="hidden" name="current_featured" value="<?php echo $product['is_featured']; ?>">
                                                <button type="submit" class="btn btn-sm btn-<?php echo $product['is_featured'] ? 'warning' : 'outline-warning'; ?>">
                                                    <i class="fas fa-star"></i>
                                                </button>
                                            </form>
                                        </td>
                                        <td class="action-buttons">
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-info"
                                                        onclick="viewProduct(<?php echo $product['id']; ?>)"
                                                        data-bs-toggle="tooltip" title="Lihat Detail">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary"
                                                        onclick="editProduct(<?php echo htmlspecialchars(json_encode($product)); ?>)"
                                                        data-bs-toggle="tooltip" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form method="POST" style="display: inline;"
                                                      onsubmit="return confirm('Yakin ingin menghapus produk ini? Data tidak dapat dikembalikan!')">
                                                    <input type="hidden" name="action" value="delete_product">
                                                    <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                            data-bs-toggle="tooltip" title="Hapus">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Tambah Produk Baru
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_product">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Produk *</label>
                                    <input type="text" class="form-control" name="nama_produk" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" name="brand">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" name="kategori_id">
                                        <option value="">Pilih Kategori</option>
                                        <?php foreach ($categories as $cat): ?>
                                            <option value="<?php echo $cat['id']; ?>"><?php echo htmlspecialchars($cat['nama_kategori']); ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Pupuk *</label>
                                    <select class="form-select" name="jenis_pupuk" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="organik">Organik</option>
                                        <option value="anorganik">Anorganik</option>
                                        <option value="hayati">Hayati</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Berat *</label>
                                    <input type="text" class="form-control" name="berat" placeholder="contoh: 25kg, 1L" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Harga *</label>
                                    <input type="number" class="form-control" name="harga" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stok *</label>
                                    <input type="number" class="form-control" name="stok" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" required>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Gambar Produk</label>
                            <input type="file" class="form-control" name="gambar" accept="image/*" onchange="previewImage(this, 'addPreview')">
                            <div id="addPreview" class="mt-2"></div>
                            <small class="text-muted">Format: JPG, PNG, GIF, WEBP. Maksimal 5MB</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" name="deskripsi" rows="3" placeholder="Deskripsi produk..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Manfaat</label>
                            <textarea class="form-control" name="manfaat" rows="3" placeholder="Manfaat produk..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cara Pakai</label>
                            <textarea class="form-control" name="cara_pakai" rows="3" placeholder="Cara penggunaan produk..."></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="addFeatured">
                                <label class="form-check-label" for="addFeatured">
                                    <i class="fas fa-star text-warning me-1"></i>
                                    Jadikan produk unggulan (Featured)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Simpan Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Edit Produk
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="update_product">
                        <input type="hidden" name="id" id="editId">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Produk *</label>
                                    <input type="text" class="form-control" name="nama_produk" id="editNamaProduk" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" name="brand" id="editBrand">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" name="kategori_id" id="editKategori">
                                        <option value="">Pilih Kategori</option>
                                        <?php foreach ($categories as $cat): ?>
                                            <option value="<?php echo $cat['id']; ?>"><?php echo htmlspecialchars($cat['nama_kategori']); ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Pupuk *</label>
                                    <select class="form-select" name="jenis_pupuk" id="editJenisPupuk" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="organik">Organik</option>
                                        <option value="anorganik">Anorganik</option>
                                        <option value="hayati">Hayati</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Berat *</label>
                                    <input type="text" class="form-control" name="berat" id="editBerat" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Harga *</label>
                                    <input type="number" class="form-control" name="harga" id="editHarga" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stok *</label>
                                    <input type="number" class="form-control" name="stok" id="editStok" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" id="editStatus" required>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Gambar Produk</label>
                            <input type="file" class="form-control" name="gambar" accept="image/*" onchange="previewImage(this, 'editPreview')">
                            <div id="editPreview" class="mt-2"></div>
                            <small class="text-muted">Kosongkan jika tidak ingin mengubah gambar</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" name="deskripsi" id="editDeskripsi" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Manfaat</label>
                            <textarea class="form-control" name="manfaat" id="editManfaat" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cara Pakai</label>
                            <textarea class="form-control" name="cara_pakai" id="editCaraPakai" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="editFeatured">
                                <label class="form-check-label" for="editFeatured">
                                    <i class="fas fa-star text-warning me-1"></i>
                                    Jadikan produk unggulan (Featured)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Batal
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save me-1"></i>
                            Update Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Product Modal -->
    <div class="modal fade" id="viewProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        Detail Produk
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewProductContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div class="modal fade" id="imageZoomModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageZoomTitle">Gambar Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="imageZoomSrc" src="" alt="" class="img-fluid rounded">
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Auto-hide alerts
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });

        // Preview image function
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Ukuran file terlalu besar! Maksimal 5MB');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '8px';
                    img.style.border = '2px solid #e9ecef';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }

        // Edit product function
        function editProduct(product) {
            document.getElementById('editId').value = product.id;
            document.getElementById('editNamaProduk').value = product.nama_produk || '';
            document.getElementById('editBrand').value = product.brand || '';
            document.getElementById('editKategori').value = product.kategori_id || '';
            document.getElementById('editJenisPupuk').value = product.jenis_pupuk || '';
            document.getElementById('editBerat').value = product.berat || '';
            document.getElementById('editHarga').value = product.harga || '';
            document.getElementById('editStok').value = product.stok || '';
            document.getElementById('editStatus').value = product.status || '';
            document.getElementById('editDeskripsi').value = product.deskripsi || '';
            document.getElementById('editManfaat').value = product.manfaat || '';
            document.getElementById('editCaraPakai').value = product.cara_pakai || '';
            document.getElementById('editFeatured').checked = product.is_featured == 1;

            // Show current image
            const editPreview = document.getElementById('editPreview');
            editPreview.innerHTML = '';
            if (product.gambar) {
                const img = document.createElement('img');
                img.src = '../assets/img/pupuk/' + product.gambar;
                img.className = 'preview-image';
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                img.style.border = '2px solid #e9ecef';
                editPreview.appendChild(img);

                const label = document.createElement('p');
                label.className = 'small text-muted mt-2 mb-0';
                label.textContent = 'Gambar saat ini';
                editPreview.appendChild(label);
            }

            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        }

        // View product function
        function viewProduct(productId) {
            const content = document.getElementById('viewProductContent');
            content.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            // Find product data
            const products = <?php echo json_encode($products); ?>;
            const product = products.find(p => p.id == productId);

            if (product) {
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            ${product.gambar ? 
                                `<img src="../assets/img/pupuk/${product.gambar}" alt="${product.nama_produk}" class="img-fluid rounded">` :
                                '<div class="bg-light p-5 text-center rounded"><i class="fas fa-image fa-3x text-muted"></i></div>'
                            }
                        </div>
                        <div class="col-md-8">
                            <h4>${product.nama_produk}</h4>
                            <div class="mb-3">
                                <span class="badge bg-${product.jenis_pupuk === 'organik' ? 'success' : (product.jenis_pupuk === 'anorganik' ? 'primary' : 'info')} me-2">
                                    ${product.jenis_pupuk.charAt(0).toUpperCase() + product.jenis_pupuk.slice(1)}
                                </span>
                                <span class="badge bg-${product.status === 'active' ? 'success' : 'secondary'} me-2">
                                    ${product.status.charAt(0).toUpperCase() + product.status.slice(1)}
                                </span>
                                ${product.is_featured == 1 ? '<span class="badge bg-warning"><i class="fas fa-star"></i> Featured</span>' : ''}
                            </div>
                            
                            <table class="table table-sm">
                                <tr>
                                    <td width="30%"><strong>Brand:</strong></td>
                                    <td>${product.brand || '-'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Kategori:</strong></td>
                                    <td>${product.nama_kategori || 'Tidak ada'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Berat:</strong></td>
                                    <td>${product.berat}</td>
                                </tr>
                                <tr>
                                    <td><strong>Harga:</strong></td>
                                    <td><strong class="text-success">Rp ${new Intl.NumberFormat('id-ID').format(product.harga)}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Stok:</strong></td>
                                    <td>
                                        <span class="badge bg-${product.stok == 0 ? 'danger' : (product.stok < 10 ? 'warning' : 'success')}">
                                            ${product.stok}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    ${product.deskripsi ? `
                        <hr>
                        <h6><i class="fas fa-info-circle me-2"></i>Deskripsi</h6>
                        <p>${product.deskripsi}</p>
                    ` : ''}
                    
                    ${product.manfaat ? `
                        <hr>
                        <h6><i class="fas fa-leaf me-2"></i>Manfaat</h6>
                        <p>${product.manfaat}</p>
                    ` : ''}
                    
                    ${product.cara_pakai ? `
                        <hr>
                        <h6><i class="fas fa-instructions me-2"></i>Cara Pakai</h6>
                        <p>${product.cara_pakai}</p>
                    ` : ''}
                `;
            } else {
                content.innerHTML = '<div class="alert alert-danger">Produk tidak ditemukan</div>';
            }

            const modal = new bootstrap.Modal(document.getElementById('viewProductModal'));
            modal.show();
        }

        // Zoom image function
        function zoomImage(src, alt) {
            document.getElementById('imageZoomSrc').src = src;
            document.getElementById('imageZoomTitle').textContent = alt;
            const modal = new bootstrap.Modal(document.getElementById('imageZoomModal'));
            modal.show();
        }

        // Export products function
        function exportProducts() {
            const format = prompt('Pilih format export:\n1. CSV\n2. Excel\n\nKetik 1 atau 2:');
            if (format === '1') {
                window.open('export_products.php?format=csv', '_blank');
            } else if (format === '2') {
                window.open('export_products.php?format=excel', '_blank');
            }
        }

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form[method="POST"]');
            forms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    const requiredFields = form.querySelectorAll('[required]');
                    let isValid = true;

                    requiredFields.forEach(function(field) {
                        if (!field.value.trim()) {
                            field.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        alert('Mohon lengkapi semua field yang wajib diisi!');
                        return false;
                    }
                });
            });
        });

        // Auto-save draft functionality
        let draftTimer;
        function saveDraft() {
            const formData = {
                nama_produk: document.querySelector('#addProductModal input[name="nama_produk"]')?.value || '',
                brand: document.querySelector('#addProductModal input[name="brand"]')?.value || '',
                jenis_pupuk: document.querySelector('#addProductModal select[name="jenis_pupuk"]')?.value || '',
                berat: document.querySelector('#addProductModal input[name="berat"]')?.value || '',
                harga: document.querySelector('#addProductModal input[name="harga"]')?.value || '',
                stok: document.querySelector('#addProductModal input[name="stok"]')?.value || '',
                deskripsi: document.querySelector('#addProductModal textarea[name="deskripsi"]')?.value || '',
                timestamp: new Date().getTime()
            };

            localStorage.setItem('product_draft', JSON.stringify(formData));
        }

        function loadDraft() {
            const draft = localStorage.getItem('product_draft');
            if (draft) {
                const data = JSON.parse(draft);
                const now = new Date().getTime();

                // Only load draft if it's less than 1 hour old
                if (now - data.timestamp < 3600000) {
                    if (confirm('Ditemukan draft yang belum disimpan. Muat draft tersebut?')) {
                        document.querySelector('#addProductModal input[name="nama_produk"]').value = data.nama_produk;
                        document.querySelector('#addProductModal input[name="brand"]').value = data.brand;
                        document.querySelector('#addProductModal select[name="jenis_pupuk"]').value = data.jenis_pupuk;
                        document.querySelector('#addProductModal input[name="berat"]').value = data.berat;
                        document.querySelector('#addProductModal input[name="harga"]').value = data.harga;
                        document.querySelector('#addProductModal input[name="stok"]').value = data.stok;
                        document.querySelector('#addProductModal textarea[name="deskripsi"]').value = data.deskripsi;
                    }
                }
            }
        }

        // Auto-save on input change
        document.addEventListener('DOMContentLoaded', function() {
            const addModal = document.getElementById('addProductModal');
            if (addModal) {
                addModal.addEventListener('shown.bs.modal', loadDraft);
                
                const inputs = addModal.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('input', function() {
                        clearTimeout(draftTimer);
                        draftTimer = setTimeout(saveDraft, 1000);
                    });
                });
            }
        });

        // Clear draft after successful submission
        <?php if ($message_type === 'success' && strpos($message, 'ditambahkan') !== false): ?>
            localStorage.removeItem('product_draft');
        <?php endif; ?>

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + N = New Product
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
                modal.show();
            }

            // Escape = Close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(function(modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
            }
        });

        // Search with debounce
        let searchTimeout;
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                document.querySelector('form').submit();
            }, 500);
        }

        // Add search debounce
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput) {
                searchInput.addEventListener('input', debounceSearch);
            }
        });

        // Format currency input
        document.addEventListener('DOMContentLoaded', function() {
            const hargaInputs = document.querySelectorAll('input[name="harga"]');
            hargaInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    // Remove non-numeric characters except decimal point
                    this.value = this.value.replace(/[^0-9.]/g, '');
                    
                    // Ensure only one decimal point
                    const parts = this.value.split('.');
                    if (parts.length > 2) {
                        this.value = parts[0] + '.' + parts.slice(1).join('');
                    }
                });
            });
        });

        // Confirm delete with product name
        function confirmDelete(productName) {
            return confirm(`Yakin ingin menghapus produk "${productName}"?\n\nData yang akan dihapus:\n- Data produk\n- Gambar produk\n- Riwayat terkait\n\nTindakan ini tidak dapat dibatalkan!`);
        }

        // Print functionality
        function printProducts() {
            window.print();
        }

        // Bulk operations
        function selectAllProducts() {
            const checkboxes = document.querySelectorAll('input[name="selected_products[]"]');
            const selectAll = document.getElementById('selectAll');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function bulkAction(action) {
            const selected = document.querySelectorAll('input[name="selected_products[]"]:checked');
            if (selected.length === 0) {
                alert('Pilih minimal satu produk untuk melakukan aksi bulk!');
                return;
            }

            let confirmMessage = '';
            switch (action) {
                case 'delete':
                    confirmMessage = `Yakin ingin menghapus ${selected.length} produk yang dipilih?`;
                    break;
                case 'activate':
                    confirmMessage = `Yakin ingin mengaktifkan ${selected.length} produk yang dipilih?`;
                    break;
                case 'deactivate':
                    confirmMessage = `Yakin ingin menonaktifkan ${selected.length} produk yang dipilih?`;
                    break;
            }

            if (confirm(confirmMessage)) {
                // Create form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.style.display = 'none';

                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'bulk_' + action;
                form.appendChild(actionInput);

                selected.forEach(checkbox => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selected_products[]';
                    input.value = checkbox.value;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            }
        }

        // Loading state for buttons
        function showLoading(button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            button.disabled = true;
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }

        // Add loading to form submissions
        document.addEventListener('DOMContentLoaded', function() {
            const submitButtons = document.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(button => {
                button.addEventListener('click', function() {
                    setTimeout(() => showLoading(this), 100);
                });
            });
        });
    </script>

    <?php
    // Calculate statistics for display
    $stats = [
        'total' => count($products),
        'active' => count(array_filter($products, function($p) { return $p['status'] === 'active'; })),
        'inactive' => count(array_filter($products, function($p) { return $p['status'] === 'inactive'; })),
        'featured' => count(array_filter($products, function($p) { return $p['is_featured'] == 1; })),
        'low_stock' => count(array_filter($products, function($p) { return $p['stok'] > 0 && $p['stok'] < 10; })),
        'out_of_stock' => count(array_filter($products, function($p) { return $p['stok'] == 0; }))
    ];
    ?>

    <script>
        // Update stats in JavaScript
        const stats = <?php echo json_encode($stats); ?>;
        
        // You can use these stats for dynamic updates
        console.log('Product Statistics:', stats);
    </script>

    <style>
        /* Additional custom styles */
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .text-purple { color: #6f42c1 !important; }

        @media print {
            .no-print, .sidebar, .modal, .btn, .filter-section {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .table {
                font-size: 12px;
            }
                        
            .product-image {
                width: 30px !important;
                height: 30px !important;
            }
        }

        /* Loading animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fa-spin {
            animation: spin 1s linear infinite;
        }

        /* Hover effects */
        .stats-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Custom scrollbar */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Modal improvements */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Form improvements */
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
            border-color: #28a745;
        }

        /* Button improvements */
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Badge improvements */
        .badge {
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Alert improvements */
        .alert {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar improvements */
        .sidebar {
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .nav-link {
            border-radius: 8px;
            margin: 2px 8px;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Image preview improvements */
        .preview-image {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .preview-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive improvements */
        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                padding: 1rem;
            }
            
            .page-header h2 {
                font-size: 1.5rem;
            }
            
            .filter-section {
                padding: 1rem;
            }
            
            .table {
                font-size: 0.85rem;
            }
            
            .action-buttons .btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #ffffff;
            }
            
            .card, .filter-section, .page-header {
                background-color: #2d2d2d;
                color: #ffffff;
            }
            
            .table {
                color: #ffffff;
            }
            
            .table th {
                background-color: #3d3d3d;
                border-color: #4d4d4d;
            }
            
            .form-control, .form-select {
                background-color: #3d3d3d;
                border-color: #4d4d4d;
                color: #ffffff;
            }
            
            .modal-content {
                background-color: #2d2d2d;
                color: #ffffff;
            }
        }

        /* Animation delays for staggered effect */
        .animate-fade-in:nth-child(1) { animation-delay: 0.1s; }
        .animate-fade-in:nth-child(2) { animation-delay: 0.2s; }
        .animate-fade-in:nth-child(3) { animation-delay: 0.3s; }
        .animate-fade-in:nth-child(4) { animation-delay: 0.4s; }

        /* Tooltip improvements */
        .tooltip {
            font-size: 0.875rem;
        }

        .tooltip-inner {
            background-color: #2d2d2d;
            border-radius: 6px;
            padding: 8px 12px;
        }

        /* Focus improvements for accessibility */
        .btn:focus,
        .form-control:focus,
        .form-select:focus {
            outline: 2px solid #28a745;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid currentColor;
            }
            
            .badge {
                border: 1px solid currentColor;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Additional JavaScript for enhanced functionality -->
    <script>
        // Show loading overlay
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Enhanced form submission with loading
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form[method="POST"]');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    showLoadingOverlay();
                    
                    // Hide loading after 5 seconds as fallback
                    setTimeout(hideLoadingOverlay, 5000);
                });
            });
        });

        // Enhanced image handling
        function handleImageError(img) {
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyMEg0MFY0MEgyMFYyMFoiIGZpbGw9IiNEQ0RDREMiLz4KPC9zdmc+';
            img.alt = 'Gambar tidak tersedia';
        }

        // Add error handling to all product images
        document.addEventListener('DOMContentLoaded', function() {
            const productImages = document.querySelectorAll('.product-image');
            productImages.forEach(img => {
                img.addEventListener('error', function() {
                    handleImageError(this);
                });
            });
        });

        // Enhanced search functionality
        function performSearch() {
            const searchTerm = document.querySelector('input[name="search"]').value;
            if (searchTerm.length >= 2 || searchTerm.length === 0) {
                showLoadingOverlay();
                document.querySelector('form').submit();
            }
        }

        // Real-time validation
        document.addEventListener('DOMContentLoaded', function() {
            const requiredInputs = document.querySelectorAll('input[required], select[required], textarea[required]');
            
            requiredInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                    }
                });
                
                input.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.classList.remove('is-invalid');
                    }
                });
            });
        });

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Keyboard navigation enhancement
        document.addEventListener('keydown', function(e) {
            // Alt + S = Search focus
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                document.querySelector('input[name="search"]').focus();
            }
            
            // Alt + A = Add product
            if (e.altKey && e.key === 'a') {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
                modal.show();
            }
        });

        // Enhanced mobile responsiveness
        function handleMobileView() {
            const isMobile = window.innerWidth <= 768;
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (isMobile) {
                sidebar.style.transform = 'translateX(-100%)';
                mainContent.style.marginLeft = '0';
            } else {
                sidebar.style.transform = 'translateX(0)';
                mainContent.style.marginLeft = '250px';
            }
        }

        // Handle window resize
        window.addEventListener('resize', handleMobileView);
        document.addEventListener('DOMContentLoaded', handleMobileView);

        // Enhanced accessibility
        document.addEventListener('DOMContentLoaded', function() {
            // Add ARIA labels
            const buttons = document.querySelectorAll('button[title]');
            buttons.forEach(button => {
                button.setAttribute('aria-label', button.getAttribute('title'));
            });
            
            // Add role attributes
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                table.setAttribute('role', 'table');
            });
        });

        // Performance optimization
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Optimized search
        const optimizedSearch = debounce(performSearch, 300);

        // Add to search input
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput) {
                searchInput.addEventListener('input', optimizedSearch);
            }
        });

        // Service Worker registration for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Analytics tracking (placeholder)
        function trackEvent(action, category, label) {
            // Implement your analytics tracking here
            console.log('Event tracked:', { action, category, label });
        }

        // Track user interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Track button clicks
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function() {
                    trackEvent('click', 'button', this.textContent.trim());
                });
            });
            
            // Track form submissions
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function() {
                    trackEvent('submit', 'form', this.getAttribute('action') || 'current_page');
                });
            });
        });

        console.log('Admin Products page loaded successfully');
    </script>
</body>
</html>


ini tampilannya next


<?php
session_start();
require_once '../includes/config.php';

// Cek apakah user adalah admin
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
    header('Location: ../login.php');
    exit();
}

$message = '';
$message_type = '';

// Handle POST requests
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['action'])) {
        switch ($_POST['action']) {
            case 'add_product':
                $nama_produk = trim($_POST['nama_produk']);
                $kategori_id = !empty($_POST['kategori_id']) ? (int)$_POST['kategori_id'] : null;
                $brand = trim($_POST['brand']);
                $jenis_pupuk = $_POST['jenis_pupuk'];
                $berat = trim($_POST['berat']);
                $harga = (float)$_POST['harga'];
                $stok = (int)$_POST['stok'];
                $deskripsi = trim($_POST['deskripsi']);
                $manfaat = trim($_POST['manfaat']);
                $cara_pakai = trim($_POST['cara_pakai']);
                $status = $_POST['status'];
                $is_featured = isset($_POST['is_featured']) ? 1 : 0;

                // Ganti semua bagian upload dengan path yang benar:

                // Handle image upload untuk ADD PRODUCT
                $gambar = null;
                if (isset($_FILES['gambar']) && $_FILES['gambar']['error'] == 0) {
                    $allowed = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                    $filename = $_FILES['gambar']['name'];
                    $filetype = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

                    if (in_array($filetype, $allowed)) {
                        $newname = 'product_' . time() . '_' . uniqid() . '.' . $filetype;

                        // UPDATE PATH KE assets/img/pupuk
                        $upload_dir = '../assets/img/pupuk/';
                        if (!file_exists($upload_dir)) {
                            mkdir($upload_dir, 0777, true);
                        }

                        $upload_path = $upload_dir . $newname;

                        if (move_uploaded_file($_FILES['gambar']['tmp_name'], $upload_path)) {
                            $gambar = $newname;
                            resizeImage($upload_path, 800, 600);
                        } else {
                            $message = 'Gagal upload gambar!';
                            $message_type = 'danger';
                        }
                    } else {
                        $message = 'Format file tidak didukung. Gunakan: JPG, PNG, GIF, WEBP';
                        $message_type = 'danger';
                    }
                }


                try {
                    $stmt = $pdo->prepare("INSERT INTO produk (nama_produk, kategori_id, brand, jenis_pupuk, berat, harga, stok, deskripsi, manfaat, cara_pakai, gambar, status, is_featured) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
                    $stmt->execute([$nama_produk, $kategori_id, $brand, $jenis_pupuk, $berat, $harga, $stok, $deskripsi, $manfaat, $cara_pakai, $gambar, $status, $is_featured]);

                    $message = 'Produk berhasil ditambahkan!';
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;

            case 'update_product':
                $id = (int)$_POST['id'];
                $nama_produk = trim($_POST['nama_produk']);
                $kategori_id = !empty($_POST['kategori_id']) ? (int)$_POST['kategori_id'] : null;
                $brand = trim($_POST['brand']);
                $jenis_pupuk = $_POST['jenis_pupuk'];
                $berat = trim($_POST['berat']);
                $harga = (float)$_POST['harga'];
                $stok = (int)$_POST['stok'];
                $deskripsi = trim($_POST['deskripsi']);
                $manfaat = trim($_POST['manfaat']);
                $cara_pakai = trim($_POST['cara_pakai']);
                $status = $_POST['status'];
                $is_featured = isset($_POST['is_featured']) ? 1 : 0;

                // Get current product data
                $stmt = $pdo->prepare("SELECT gambar FROM produk WHERE id = ?");
                $stmt->execute([$id]);
                $current_product = $stmt->fetch();
                $gambar = $current_product['gambar'];

                // Handle image upload untuk UPDATE PRODUCT
                if (isset($_FILES['gambar']) && $_FILES['gambar']['error'] == 0) {
                    $allowed = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                    $filename = $_FILES['gambar']['name'];
                    $filetype = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

                    if (in_array($filetype, $allowed)) {
                        $newname = 'product_' . time() . '_' . uniqid() . '.' . $filetype;
                        $upload_path = '../assets/img/pupuk/' . $newname;

                        if (move_uploaded_file($_FILES['gambar']['tmp_name'], $upload_path)) {
                            // Delete old image
                            if ($gambar && file_exists('../assets/img/pupuk/' . $gambar)) {
                                unlink('../assets/img/pupuk/' . $gambar);
                            }

                            $gambar = $newname;
                            resizeImage($upload_path, 800, 600);
                        }
                    }
                }


                try {
                    $stmt = $pdo->prepare("UPDATE produk SET nama_produk = ?, kategori_id = ?, brand = ?, jenis_pupuk = ?, berat = ?, harga = ?, stok = ?, deskripsi = ?, manfaat = ?, cara_pakai = ?, gambar = ?, status = ?, is_featured = ? WHERE id = ?");
                    $stmt->execute([$nama_produk, $kategori_id, $brand, $jenis_pupuk, $berat, $harga, $stok, $deskripsi, $manfaat, $cara_pakai, $gambar, $status, $is_featured, $id]);

                    $message = 'Produk berhasil diupdate!';
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;

            case 'delete_product':
                $id = (int)$_POST['id'];

                try {
                    // Get product image
                    $stmt = $pdo->prepare("SELECT gambar FROM produk WHERE id = ?");
                    $stmt->execute([$id]);
                    $product = $stmt->fetch();

                    // Delete product
                    $stmt = $pdo->prepare("DELETE FROM produk WHERE id = ?");
                    $stmt->execute([$id]);

                    // Delete image file dengan path yang benar
                    if ($product && $product['gambar'] && file_exists('../assets/img/pupuk/' . $product['gambar'])) {
                        unlink('../assets/img/pupuk/' . $product['gambar']);
                    }

                    $message = 'Produk berhasil dihapus!';
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;


            case 'toggle_status':
                $id = (int)$_POST['id'];
                $current_status = $_POST['current_status'];
                $new_status = $current_status === 'active' ? 'inactive' : 'active';

                try {
                    $stmt = $pdo->prepare("UPDATE produk SET status = ? WHERE id = ?");
                    $stmt->execute([$new_status, $id]);

                    $message = "Status produk berhasil diubah menjadi $new_status!";
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;

            case 'toggle_featured':
                $id = (int)$_POST['id'];
                $current_featured = (int)$_POST['current_featured'];
                $new_featured = $current_featured ? 0 : 1;

                try {
                    $stmt = $pdo->prepare("UPDATE produk SET is_featured = ? WHERE id = ?");
                    $stmt->execute([$new_featured, $id]);

                    $status_text = $new_featured ? 'featured' : 'tidak featured';
                    $message = "Produk berhasil diubah menjadi $status_text!";
                    $message_type = 'success';
                } catch (PDOException $e) {
                    $message = 'Error: ' . $e->getMessage();
                    $message_type = 'danger';
                }
                break;
        }
    }
}

// Get categories for dropdown
$categories_stmt = $pdo->query("SELECT * FROM kategori ORDER BY nama_kategori");
$categories = $categories_stmt->fetchAll();

// Get filters
$search = $_GET['search'] ?? '';
$jenis_filter = $_GET['jenis'] ?? '';
$status_filter = $_GET['status'] ?? '';
$kategori_filter = $_GET['kategori'] ?? '';
$featured_filter = $_GET['featured'] ?? '';
$stok_rendah = $_GET['stok_rendah'] ?? '';
$sort = $_GET['sort'] ?? 'created_at';
$order = $_GET['order'] ?? 'DESC';

// Build query
$sql = "SELECT p.*, k.nama_kategori 
        FROM produk p 
        LEFT JOIN kategori k ON p.kategori_id = k.id 
        WHERE 1=1";

$params = [];

if ($search) {
    $sql .= " AND (p.nama_produk LIKE ? OR p.brand LIKE ? OR k.nama_kategori LIKE ?)";
    $search_param = "%$search%";
    $params[] = $search_param;
    $params[] = $search_param;
    $params[] = $search_param;
}

if ($jenis_filter) {
    $sql .= " AND p.jenis_pupuk = ?";
    $params[] = $jenis_filter;
}

if ($status_filter) {
    $sql .= " AND p.status = ?";
    $params[] = $status_filter;
}

if ($kategori_filter) {
    $sql .= " AND p.kategori_id = ?";
    $params[] = $kategori_filter;
}

if ($featured_filter !== '') {
    $sql .= " AND p.is_featured = ?";
    $params[] = (int)$featured_filter;
}

if ($stok_rendah) {
    $sql .= " AND p.stok < 10";
}

$sql .= " ORDER BY p.$sort $order";

$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$products = $stmt->fetchAll();

// Get product for edit
$edit_product = null;
if (isset($_GET['edit']) && is_numeric($_GET['edit'])) {
    $edit_id = (int)$_GET['edit'];
    $stmt = $pdo->prepare("SELECT * FROM produk WHERE id = ?");
    $stmt->execute([$edit_id]);
    $edit_product = $stmt->fetch();
}

// Function untuk resize image
function resizeImage($file, $maxWidth, $maxHeight)
{
    $info = getimagesize($file);
    if (!$info) return false;

    $width = $info[0];
    $height = $info[1];
    $type = $info[2];

    // Calculate new dimensions
    $ratio = min($maxWidth / $width, $maxHeight / $height);
    $newWidth = round($width * $ratio);
    $newHeight = round($height * $ratio);

    // Create image resource
    switch ($type) {
        case IMAGETYPE_JPEG:
            $source = imagecreatefromjpeg($file);
            break;
        case IMAGETYPE_PNG:
            $source = imagecreatefrompng($file);
            break;
        case IMAGETYPE_GIF:
            $source = imagecreatefromgif($file);
            break;
        case IMAGETYPE_WEBP:
            $source = imagecreatefromwebp($file);
            break;
        default:
            return false;
    }

    if (!$source) return false;

    // Create new image
    $destination = imagecreatetruecolor($newWidth, $newHeight);

    // Preserve transparency
    if ($type == IMAGETYPE_PNG || $type == IMAGETYPE_GIF) {
        imagealphablending($destination, false);
        imagesavealpha($destination, true);
        $transparent = imagecolorallocatealpha($destination, 255, 255, 255, 127);
        imagefilledrectangle($destination, 0, 0, $newWidth, $newHeight, $transparent);
    }

    // Resize
    imagecopyresampled($destination, $source, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);

    // Save
    switch ($type) {
        case IMAGETYPE_JPEG:
            imagejpeg($destination, $file, 90);
            break;
        case IMAGETYPE_PNG:
            imagepng($destination, $file, 9);
            break;
        case IMAGETYPE_GIF:
            imagegif($destination, $file);
            break;
        case IMAGETYPE_WEBP:
            imagewebp($destination, $file, 90);
            break;
    }

    // Clean up
    imagedestroy($source);
    imagedestroy($destination);

    return true;
}
?>

<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Produk - Admin PupukKita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .status-badge {
            font-size: 0.75rem;
        }

        .action-buttons {
            white-space: nowrap;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Detail Modal Styles */
        #detailProductModal .modal-dialog {
            max-width: 1000px;
        }

        #detailProductModal .table td {
            padding: 0.5rem 0;
            border: none;
        }

        #detailProductModal .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
        }

        #detailProductModal .nav-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-radius: 5px;
        }

        #detailProductModal .tab-content {
            min-height: 120px;
        }

        #detailProductModal .tab-pane p {
            line-height: 1.6;
        }

        .detail-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }

        .detail-image-container img {
            transition: transform 0.3s ease;
        }

        .detail-image-container:hover img {
            transform: scale(1.05);
        }
    </style>
</head>

<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 bg-dark text-white p-0">
                <div class="d-flex flex-column min-vh-100">
                    <div class="p-3">
                        <h5><i class="fas fa-leaf"></i> PupukKita Admin</h5>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link text-white" href="dashboard.php">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a class="nav-link text-white active bg-primary" href="products.php">
                            <i class="fas fa-box"></i> Kelola Produk
                        </a>
                        <a class="nav-link text-white" href="orders.php">
                            <i class="fas fa-shopping-cart"></i> Kelola Pesanan
                        </a>
                        <a class="nav-link text-white" href="categories.php">
                            <i class="fas fa-tags"></i> Kategori
                        </a>
                        <a class="nav-link text-white" href="users.php">
                            <i class="fas fa-users"></i> Pengguna
                        </a>
                    </nav>
                    <div class="mt-auto p-3">
                        <a href="../logout.php" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-box"></i> Kelola Produk</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus"></i> Tambah Produk
                    </button>
                </div>

                <!-- Alert Messages -->
                <?php if ($message): ?>
                    <div class="alert alert-<?php echo $message_type; ?> alert-dismissible fade show" role="alert">
                        <?php echo $message; ?>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <?php endif; ?>

                <!-- Filter Section -->
                <div class="filter-section">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Pencarian</label>
                            <input type="text" class="form-control" name="search" value="<?php echo htmlspecialchars($search); ?>" placeholder="Cari produk...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Jenis Pupuk</label>
                            <select class="form-select" name="jenis">
                                <option value="">Semua Jenis</option>
                                <option value="organik" <?php echo $jenis_filter === 'organik' ? 'selected' : ''; ?>>Organik</option>
                                <option value="anorganik" <?php echo $jenis_filter === 'anorganik' ? 'selected' : ''; ?>>Anorganik</option>
                                <option value="hayati" <?php echo $jenis_filter === 'hayati' ? 'selected' : ''; ?>>Hayati</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status">
                                <option value="">Semua Status</option>
                                <option value="active" <?php echo $status_filter === 'active' ? 'selected' : ''; ?>>Active</option>
                                <option value="inactive" <?php echo $status_filter === 'inactive' ? 'selected' : ''; ?>>Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Kategori</label>
                            <select class="form-select" name="kategori">
                                <option value="">Semua Kategori</option>
                                <?php foreach ($categories as $cat): ?>
                                    <option value="<?php echo $cat['id']; ?>" <?php echo $kategori_filter == $cat['id'] ? 'selected' : ''; ?>>
                                        <?php echo htmlspecialchars($cat['nama_kategori']); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Featured</label>
                            <select class="form-select" name="featured">
                                <option value="">Semua</option>
                                <option value="1" <?php echo $featured_filter === '1' ? 'selected' : ''; ?>>Featured</option>
                                <option value="0" <?php echo $featured_filter === '0' ? 'selected' : ''; ?>>Not Featured</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="btn-group" role="group">
                                <a href="?stok_rendah=1" class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-exclamation-triangle"></i> Stok Rendah
                                </a>
                                <a href="?" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-refresh"></i> Reset Filter
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="table-responsive">
                    <table class="table table-hover bg-white">
                        <thead class="table-dark">
                            <tr>
                                <th>Gambar</th>
                                <th>
                                    <a href="?<?php echo http_build_query(array_merge($_GET, ['sort' => 'nama_produk', 'order' => $order === 'ASC' ? 'DESC' : 'ASC'])); ?>" class="text-white text-decoration-none">
                                        Nama Produk <i class="fas fa-sort"></i>
                                    </a>
                                </th>
                                <th>Kategori</th>
                                <th>Brand</th>
                                <th>Jenis</th>
                                <th>Berat</th>
                                <th>
                                    <a href="?<?php echo http_build_query(array_merge($_GET, ['sort' => 'harga', 'order' => $order === 'ASC' ? 'DESC' : 'ASC'])); ?>" class="text-white text-decoration-none">
                                        Harga <i class="fas fa-sort"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="?<?php echo http_build_query(array_merge($_GET, ['sort' => 'stok', 'order' => $order === 'ASC' ? 'DESC' : 'ASC'])); ?>" class="text-white text-decoration-none">
                                        Stok <i class="fas fa-sort"></i>
                                    </a>
                                </th>
                                <th>Status</th>
                                <th>Featured</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($products)): ?>
                                <tr>
                                    <td colspan="11" class="text-center py-4">
                                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Tidak ada produk ditemukan</p>
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php foreach ($products as $product): ?>
                                    <tr>
                                        <td>
                                            <?php if ($product['gambar']): ?>
                                                <img src="../assets/img/pupuk/<?php echo htmlspecialchars($product['gambar']); ?>"
                                                    alt="<?php echo htmlspecialchars($product['nama_produk']); ?>"
                                                    class="product-image"
                                                    onclick="zoomImage('../assets/img/pupuk/<?php echo htmlspecialchars($product['gambar']); ?>', '<?php echo htmlspecialchars($product['nama_produk']); ?>')">
                                            <?php else: ?>
                                                <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <strong><?php echo htmlspecialchars($product['nama_produk']); ?></strong>
                                            <br>
                                            <small class="text-muted">ID: <?php echo $product['id']; ?></small>
                                        </td>
                                        <td><?php echo htmlspecialchars($product['nama_kategori'] ?? 'Tidak ada'); ?></td>
                                        <td><?php echo htmlspecialchars($product['brand'] ?? '-'); ?></td>
                                        <td>
                                            <span class="badge bg-<?php echo $product['jenis_pupuk'] === 'organik' ? 'success' : ($product['jenis_pupuk'] === 'anorganik' ? 'primary' : 'info'); ?>">
                                                <?php echo ucfirst($product['jenis_pupuk']); ?>
                                            </span>
                                        </td>
                                        <td><?php echo htmlspecialchars($product['berat']); ?></td>
                                        <td>Rp <?php echo number_format($product['harga'], 0, ',', '.'); ?></td>
                                        <td>
                                            <span class="badge bg-<?php echo $product['stok'] < 10 ? 'danger' : ($product['stok'] < 50 ? 'warning' : 'success'); ?>">
                                                <?php echo $product['stok']; ?>
                                            </span>
                                        </td>
                                        <td>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_status">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <input type="hidden" name="current_status" value="<?php echo $product['status']; ?>">
                                                <button type="submit" class="btn btn-sm btn-<?php echo $product['status'] === 'active' ? 'success' : 'secondary'; ?>"
                                                    onclick="return confirm('Yakin ingin mengubah status produk ini?')">
                                                    <?php echo ucfirst($product['status']); ?>
                                                </button>
                                            </form>
                                        </td>
                                        <td>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_featured">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <input type="hidden" name="current_featured" value="<?php echo $product['is_featured']; ?>">
                                                <button type="submit" class="btn btn-sm btn-<?php echo $product['is_featured'] ? 'warning' : 'outline-warning'; ?>">
                                                    <i class="fas fa-star"></i>
                                                </button>
                                            </form>
                                        </td>
                                        <td class="action-buttons">
                                            <button class="btn btn-info btn-sm"
                                                onclick="viewProduct(<?php echo htmlspecialchars(json_encode($product)); ?>)"
                                                title="Lihat Detail">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm"
                                                onclick="editProduct(<?php echo htmlspecialchars(json_encode($product)); ?>)"
                                                title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="POST" style="display: inline;"
                                                onsubmit="return confirm('Yakin ingin menghapus produk ini? Data tidak dapat dikembalikan!')">
                                                <input type="hidden" name="action" value="delete_product">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <button type="submit" class="btn btn-danger btn-sm" title="Hapus">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>

                <!-- Statistics -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Statistik Produk</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h4 class="text-primary"><?php echo count($products); ?></h4>
                                            <small class="text-muted">Total Produk</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h4 class="text-success">
                                                <?php echo count(array_filter($products, function ($p) {
                                                    return $p['status'] === 'active';
                                                })); ?>
                                            </h4>
                                            <small class="text-muted">Produk Aktif</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h4 class="text-warning">
                                                <?php echo count(array_filter($products, function ($p) {
                                                    return $p['stok'] < 10;
                                                })); ?>
                                            </h4>
                                            <small class="text-muted">Stok Rendah</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h4 class="text-info">
                                                <?php echo count(array_filter($products, function ($p) {
                                                    return $p['is_featured'];
                                                })); ?>
                                            </h4>
                                            <small class="text-muted">Featured</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Tambah Produk Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_product">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Produk *</label>
                                    <input type="text" class="form-control" name="nama_produk" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" name="brand">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" name="kategori_id">
                                        <option value="">Pilih Kategori</option>
                                        <?php foreach ($categories as $cat): ?>
                                            <option value="<?php echo $cat['id']; ?>"><?php echo htmlspecialchars($cat['nama_kategori']); ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Pupuk *</label>
                                    <select class="form-select" name="jenis_pupuk" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="organik">Organik</option>
                                        <option value="anorganik">Anorganik</option>
                                        <option value="hayati">Hayati</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Berat *</label>
                                    <input type="text" class="form-control" name="berat" placeholder="contoh: 25kg, 1L" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Harga *</label>
                                    <input type="number" class="form-control" name="harga" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stok *</label>
                                    <input type="number" class="form-control" name="stok" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" required>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Gambar Produk</label>
                            <input type="file" class="form-control" name="gambar" accept="image/*" onchange="previewImage(this, 'addPreview')">
                            <div id="addPreview" class="mt-2"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" name="deskripsi" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Manfaat</label>
                            <textarea class="form-control" name="manfaat" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cara Pakai</label>
                            <textarea class="form-control" name="cara_pakai" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="addFeatured">
                                <label class="form-check-label" for="addFeatured">
                                    Jadikan produk unggulan (Featured)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Detail Product Modal -->
    <div class="modal fade" id="detailProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye"></i> Detail Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <div id="detailImageContainer" class="text-center">
                                <img id="detailImage" src="" alt="" class="img-fluid rounded" style="max-height: 300px;">
                                <div id="detailNoImage" class="bg-light p-5 rounded" style="display: none;">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                    <p class="mt-2 text-muted">Tidak ada gambar</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-7">
                            <h3 id="detailNamaProduk" class="mb-3"></h3>

                            <div class="mb-3">
                                <span id="detailJenisBadge" class="badge me-2"></span>
                                <span id="detailFeaturedBadge" class="badge bg-warning" style="display: none;">
                                    <i class="fas fa-star"></i> Featured
                                </span>
                            </div>

                            <table class="table table-borderless">
                                <tr>
                                    <td width="30%"><strong>ID Produk:</strong></td>
                                    <td id="detailId"></td>
                                </tr>
                                <tr>
                                    <td><strong>Brand:</strong></td>
                                    <td id="detailBrand"></td>
                                </tr>
                                <tr>
                                    <td><strong>Kategori:</strong></td>
                                    <td id="detailKategori"></td>
                                </tr>
                                <tr>
                                    <td><strong>Berat:</strong></td>
                                    <td id="detailBerat"></td>
                                </tr>
                                <tr>
                                    <td><strong>Harga:</strong></td>
                                    <td>
                                        <h4 class="text-success mb-0" id="detailHarga"></h4>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Stok:</strong></td>
                                    <td><span id="detailStokBadge" class="badge"></span></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span id="detailStatusBadge" class="badge"></span></td>
                                </tr>
                                <tr>
                                    <td><strong>Dibuat:</strong></td>
                                    <td id="detailCreated"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="detail-description-tab" data-bs-toggle="tab"
                                        data-bs-target="#detail-description" type="button" role="tab">
                                        <i class="fas fa-info-circle"></i> Deskripsi
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="detail-benefits-tab" data-bs-toggle="tab"
                                        data-bs-target="#detail-benefits" type="button" role="tab">
                                        <i class="fas fa-leaf"></i> Manfaat
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="detail-usage-tab" data-bs-toggle="tab"
                                        data-bs-target="#detail-usage" type="button" role="tab">
                                        <i class="fas fa-instructions"></i> Cara Pakai
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content mt-3" id="detailTabsContent">
                                <div class="tab-pane fade show active" id="detail-description" role="tabpanel">
                                    <div class="p-3 bg-light rounded">
                                        <p id="detailDeskripsi" class="mb-0"></p>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="detail-benefits" role="tabpanel">
                                    <div class="p-3 bg-light rounded">
                                        <p id="detailManfaat" class="mb-0"></p>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="detail-usage" role="tabpanel">
                                    <div class="p-3 bg-light rounded">
                                        <p id="detailCaraPakai" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                    <button type="button" class="btn btn-warning" onclick="editProductFromDetail()">
                        <i class="fas fa-edit"></i> Edit Produk
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="update_product">
                        <input type="hidden" name="id" id="editId">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Produk *</label>
                                    <input type="text" class="form-control" name="nama_produk" id="editNamaProduk" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" name="brand" id="editBrand">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" name="kategori_id" id="editKategori">
                                        <option value="">Pilih Kategori</option>
                                        <?php foreach ($categories as $cat): ?>
                                            <option value="<?php echo $cat['id']; ?>"><?php echo htmlspecialchars($cat['nama_kategori']); ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Pupuk *</label>
                                    <select class="form-select" name="jenis_pupuk" id="editJenisPupuk" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="organik">Organik</option>
                                        <option value="anorganik">Anorganik</option>
                                        <option value="hayati">Hayati</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Berat *</label>
                                    <input type="text" class="form-control" name="berat" id="editBerat" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Harga *</label>
                                    <input type="number" class="form-control" name="harga" id="editHarga" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stok *</label>
                                    <input type="number" class="form-control" name="stok" id="editStok" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" id="editStatus" required>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Gambar Produk</label>
                            <input type="file" class="form-control" name="gambar" accept="image/*" onchange="previewImage(this, 'editPreview')">
                            <div id="editPreview" class="mt-2"></div>
                            <small class="text-muted">Kosongkan jika tidak ingin mengubah gambar</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" name="deskripsi" id="editDeskripsi" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Manfaat</label>
                            <textarea class="form-control" name="manfaat" id="editManfaat" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cara Pakai</label>
                            <textarea class="form-control" name="cara_pakai" id="editCaraPakai" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="editFeatured">
                                <label class="form-check-label" for="editFeatured">
                                    Jadikan produk unggulan (Featured)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Update Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function untuk preview image
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Function untuk view detail produk
        function viewProduct(product) {
            // Set basic info
            document.getElementById('detailId').textContent = product.id;
            document.getElementById('detailNamaProduk').textContent = product.nama_produk || '-';
            document.getElementById('detailBrand').textContent = product.brand || '-';
            document.getElementById('detailKategori').textContent = product.nama_kategori || 'Tidak ada kategori';
            document.getElementById('detailBerat').textContent = product.berat || '-';
            document.getElementById('detailHarga').textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(product.harga || 0);
            document.getElementById('detailCreated').textContent = product.created_at ? new Date(product.created_at).toLocaleDateString('id-ID') : '-';

            // Set jenis pupuk badge
            const jenisBadge = document.getElementById('detailJenisBadge');
            jenisBadge.textContent = product.jenis_pupuk ? product.jenis_pupuk.charAt(0).toUpperCase() + product.jenis_pupuk.slice(1) : '-';
            jenisBadge.className = 'badge me-2 bg-' + (
                product.jenis_pupuk === 'organik' ? 'success' :
                product.jenis_pupuk === 'anorganik' ? 'primary' : 'info'
            );

            // Set featured badge
            const featuredBadge = document.getElementById('detailFeaturedBadge');
            featuredBadge.style.display = product.is_featured == 1 ? 'inline-block' : 'none';

            // Set stok badge
            const stokBadge = document.getElementById('detailStokBadge');
            stokBadge.textContent = (product.stok || 0) + ' tersedia';
            stokBadge.className = 'badge bg-' + (
                product.stok < 10 ? 'danger' :
                product.stok < 50 ? 'warning' : 'success'
            );

            // Set status badge
            const statusBadge = document.getElementById('detailStatusBadge');
            statusBadge.textContent = product.status ? product.status.charAt(0).toUpperCase() + product.status.slice(1) : '-';
            statusBadge.className = 'badge bg-' + (product.status === 'active' ? 'success' : 'secondary');

            // Set image
            const detailImage = document.getElementById('detailImage');
            const detailNoImage = document.getElementById('detailNoImage');

            if (product.gambar) {
                detailImage.src = '../assets/img/pupuk/' + product.gambar;
                detailImage.alt = product.nama_produk;
                detailImage.style.display = 'block';
                detailNoImage.style.display = 'none';
            } else {
                detailImage.style.display = 'none';
                detailNoImage.style.display = 'block';
            }

            // Set descriptions
            document.getElementById('detailDeskripsi').innerHTML = product.deskripsi ?
                product.deskripsi.replace(/\n/g, '<br>') :
                '<em class="text-muted">Tidak ada deskripsi tersedia</em>';

            document.getElementById('detailManfaat').innerHTML = product.manfaat ?
                product.manfaat.replace(/\n/g, '<br>') :
                '<em class="text-muted">Tidak ada informasi manfaat tersedia</em>';

            document.getElementById('detailCaraPakai').innerHTML = product.cara_pakai ?
                product.cara_pakai.replace(/\n/g, '<br>') :
                '<em class="text-muted">Tidak ada informasi cara pakai tersedia</em>';

            // Store product data for edit function
            window.currentDetailProduct = product;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('detailProductModal'));
            modal.show();
        }

        // Function untuk edit dari detail modal
        function editProductFromDetail() {
            if (window.currentDetailProduct) {
                // Close detail modal first
                const detailModal = bootstrap.Modal.getInstance(document.getElementById('detailProductModal'));
                detailModal.hide();

                // Wait a bit then open edit modal
                setTimeout(() => {
                    editProduct(window.currentDetailProduct);
                }, 300);
            }
        }

        // Function untuk edit produk
        function editProduct(product) {
            // Populate form fields
            document.getElementById('editId').value = product.id;
            document.getElementById('editNamaProduk').value = product.nama_produk || '';
            document.getElementById('editBrand').value = product.brand || '';
            document.getElementById('editKategori').value = product.kategori_id || '';
            document.getElementById('editJenisPupuk').value = product.jenis_pupuk || '';
            document.getElementById('editBerat').value = product.berat || '';
            document.getElementById('editHarga').value = product.harga || '';
            document.getElementById('editStok').value = product.stok || '';
            document.getElementById('editStatus').value = product.status || '';
            document.getElementById('editDeskripsi').value = product.deskripsi || '';
            document.getElementById('editManfaat').value = product.manfaat || '';
            document.getElementById('editCaraPakai').value = product.cara_pakai || '';
            document.getElementById('editFeatured').checked = product.is_featured == 1;

            // Show current image if exists
            const editPreview = document.getElementById('editPreview');
            editPreview.innerHTML = '';
            if (product.gambar) {
                const img = document.createElement('img');
                img.src = '../assets/img/pupuk/' + product.gambar; // UPDATE PATH
                img.className = 'preview-image';
                img.alt = 'Current Image';
                editPreview.appendChild(img);

                const label = document.createElement('p');
                label.className = 'small text-muted mt-2';
                label.textContent = 'Gambar saat ini';
                editPreview.appendChild(label);
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        }

        // Auto-hide alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });

        // Confirm delete with more details
        function confirmDelete(productName) {
            return confirm(`Yakin ingin menghapus produk "${productName}"?\n\nData yang akan dihapus:\n- Data produk\n- Gambar produk\n- Riwayat terkait\n\nTindakan ini tidak dapat dibatalkan!`);
        }

        // Format currency input
        document.addEventListener('DOMContentLoaded', function() {
            const hargaInputs = document.querySelectorAll('input[name="harga"]');
            hargaInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    // Remove non-numeric characters except decimal point
                    this.value = this.value.replace(/[^0-9.]/g, '');

                    // Ensure only one decimal point
                    const parts = this.value.split('.');
                    if (parts.length > 2) {
                        this.value = parts[0] + '.' + parts.slice(1).join('');
                    }
                });
            });
        });

        // Bulk actions
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('input[name="selected_products[]"]');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = source.checked;
            });
        }

        function bulkAction(action) {
            const selected = document.querySelectorAll('input[name="selected_products[]"]:checked');
            if (selected.length === 0) {
                alert('Pilih minimal satu produk untuk melakukan aksi bulk!');
                return;
            }

            let confirmMessage = '';
            switch (action) {
                case 'delete':
                    confirmMessage = `Yakin ingin menghapus ${selected.length} produk yang dipilih?`;
                    break;
                case 'activate':
                    confirmMessage = `Yakin ingin mengaktifkan ${selected.length} produk yang dipilih?`;
                    break;
                case 'deactivate':
                    confirmMessage = `Yakin ingin menonaktifkan ${selected.length} produk yang dipilih?`;
                    break;
                case 'feature':
                    confirmMessage = `Yakin ingin menjadikan ${selected.length} produk sebagai featured?`;
                    break;
                case 'unfeature':
                    confirmMessage = `Yakin ingin menghapus ${selected.length} produk dari featured?`;
                    break;
            }

            if (confirm(confirmMessage)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.style.display = 'none';

                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'bulk_' + action;
                form.appendChild(actionInput);

                selected.forEach(function(checkbox) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selected_products[]';
                    input.value = checkbox.value;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            }
        }

        // Search with debounce
        let searchTimeout;

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                document.querySelector('form').submit();
            }, 500);
        }

        // Add event listener to search input
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput) {
                searchInput.addEventListener('input', debounceSearch);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + N = New Product
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
                modal.show();
            }

            // Escape = Close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(function(modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
            }
        });

        // Tooltip initialization
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            const tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form[method="POST"]');
            forms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    const requiredFields = form.querySelectorAll('[required]');
                    let isValid = true;

                    requiredFields.forEach(function(field) {
                        if (!field.value.trim()) {
                            field.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        alert('Mohon lengkapi semua field yang wajib diisi!');
                    }
                });
            });
        });

        // Auto-save draft (localStorage)
        function saveDraft() {
            const formData = {
                nama_produk: document.querySelector('input[name="nama_produk"]').value,
                brand: document.querySelector('input[name="brand"]').value,
                jenis_pupuk: document.querySelector('select[name="jenis_pupuk"]').value,
                berat: document.querySelector('input[name="berat"]').value,
                harga: document.querySelector('input[name="harga"]').value,
                stok: document.querySelector('input[name="stok"]').value,
                deskripsi: document.querySelector('textarea[name="deskripsi"]').value,
                timestamp: new Date().getTime()
            };

            localStorage.setItem('product_draft', JSON.stringify(formData));
        }

        function loadDraft() {
            const draft = localStorage.getItem('product_draft');
            if (draft) {
                const data = JSON.parse(draft);
                const now = new Date().getTime();

                // Only load draft if it's less than 1 hour old
                if (now - data.timestamp < 3600000) {
                    if (confirm('Ditemukan draft yang belum disimpan. Muat draft tersebut?')) {
                        document.querySelector('input[name="nama_produk"]').value = data.nama_produk || '';
                        document.querySelector('input[name="brand"]').value = data.brand || '';
                        document.querySelector('select[name="jenis_pupuk"]').value = data.jenis_pupuk || '';
                        document.querySelector('input[name="berat"]').value = data.berat || '';
                        document.querySelector('input[name="harga"]').value = data.harga || '';
                        document.querySelector('input[name="stok"]').value = data.stok || '';
                        document.querySelector('textarea[name="deskripsi"]').value = data.deskripsi || '';
                    }
                }
            }
        }

        // Clear draft after successful submission
        function clearDraft() {
            localStorage.removeItem('product_draft');
        }

        // Export functions
        function exportProducts(format) {
            const url = `export_products.php?format=${format}`;
            window.open(url, '_blank');
        }

        // Print function
        function printProducts() {
            window.print();
        }

        // Update zoomImage function
        function zoomImage(src, alt) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${alt}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="${src}" alt="${alt}" class="img-fluid">
                </div>
            </div>
        </div>
        `;

            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        // Add click event to product images
        document.addEventListener('DOMContentLoaded', function() {
            const productImages = document.querySelectorAll('.product-image');
            productImages.forEach(function(img) {
                img.style.cursor = 'pointer';
                img.addEventListener('click', function() {
                    zoomImage(this.src, this.alt);
                });
            });
        });
    </script>

    <style>
        @media print {
            .no-print {
                display: none !important;
            }

            .table {
                font-size: 12px;
            }

            .product-image {
                width: 40px;
                height: 40px;
            }
        }

        .is-invalid {
            border-color: #dc3545;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, .075);
        }

        .action-buttons .btn {
            margin: 1px;
        }

        .badge {
            font-size: 0.75em;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .modal-lg {
            max-width: 900px;
        }

        .preview-image {
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .preview-image:hover {
            border-color: #0d6efd;
            transform: scale(1.05);
        }

        .filter-section {
            border-left: 4px solid #0d6efd;
        }

        .table thead th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .nav-link.active {
            border-radius: 5px;
        }

        .btn-group .btn {
            border-radius: 0;
        }

        .btn-group .btn:first-child {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }

        .btn-group .btn:last-child {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }
    </style>
</body>

</html>



ini product catat
<?php
    session_start();
    require_once '../includes/config.php';

    // Cek apakah user adalah admin
    if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
        header('Location: ../login.php');
        exit();
    }

    $message = '';
    $message_type = '';

    // Handle POST requests
    if ($_SERVER['REQUEST_METHOD'] == 'POST') {
        if (isset($_POST['action'])) {
            switch ($_POST['action']) {
                case 'add_product':
                    $nama_produk = trim($_POST['nama_produk']);
                    $kategori_id = !empty($_POST['kategori_id']) ? (int)$_POST['kategori_id'] : null;
                    $brand = trim($_POST['brand']);
                    $jenis_pupuk = $_POST['jenis_pupuk'];
                    $berat = trim($_POST['berat']);
                    $harga = (float)$_POST['harga'];
                    $stok = (int)$_POST['stok'];
                    $deskripsi = trim($_POST['deskripsi']);
                    $manfaat = trim($_POST['manfaat']);
                    $cara_pakai = trim($_POST['cara_pakai']);
                    $status = $_POST['status'];
                    $is_featured = isset($_POST['is_featured']) ? 1 : 0;

                    // Handle image upload untuk ADD PRODUCT
                    $gambar = null;
                    if (isset($_FILES['gambar']) && $_FILES['gambar']['error'] == 0) {
                        $allowed = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                        $filename = $_FILES['gambar']['name'];
                        $filetype = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

                        if (in_array($filetype, $allowed)) {
                            $newname = 'product_' . time() . '_' . uniqid() . '.' . $filetype;
                            $upload_dir = '../assets/img/pupuk/';
                            if (!file_exists($upload_dir)) {
                                mkdir($upload_dir, 0777, true);
                            }

                            $upload_path = $upload_dir . $newname;

                            if (move_uploaded_file($_FILES['gambar']['tmp_name'], $upload_path)) {
                                $gambar = $newname;
                                resizeImage($upload_path, 800, 600);
                            } else {
                                $message = 'Gagal upload gambar!';
                                $message_type = 'danger';
                            }
                        } else {
                            $message = 'Format file tidak didukung. Gunakan: JPG, PNG, GIF, WEBP';
                            $message_type = 'danger';
                        }
                    }

                    try {
                        $stmt = $pdo->prepare("INSERT INTO produk (nama_produk, kategori_id, brand, jenis_pupuk, berat, harga, stok, deskripsi, manfaat, cara_pakai, gambar, status, is_featured) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
                        $stmt->execute([$nama_produk, $kategori_id, $brand, $jenis_pupuk, $berat, $harga, $stok, $deskripsi, $manfaat, $cara_pakai, $gambar, $status, $is_featured]);

                        $message = 'Produk berhasil ditambahkan!';
                        $message_type = 'success';
                    } catch (PDOException $e) {
                        $message = 'Error: ' . $e->getMessage();
                        $message_type = 'danger';
                    }
                    break;

                case 'update_product':
                    $id = (int)$_POST['id'];
                    $nama_produk = trim($_POST['nama_produk']);
                    $kategori_id = !empty($_POST['kategori_id']) ? (int)$_POST['kategori_id'] : null;
                    $brand = trim($_POST['brand']);
                    $jenis_pupuk = $_POST['jenis_pupuk'];
                    $berat = trim($_POST['berat']);
                    $harga = (float)$_POST['harga'];
                    $stok = (int)$_POST['stok'];
                    $deskripsi = trim($_POST['deskripsi']);
                    $manfaat = trim($_POST['manfaat']);
                    $cara_pakai = trim($_POST['cara_pakai']);
                    $status = $_POST['status'];
                    $is_featured = isset($_POST['is_featured']) ? 1 : 0;

                    // Get current product data
                    $stmt = $pdo->prepare("SELECT gambar FROM produk WHERE id = ?");
                    $stmt->execute([$id]);
                    $current_product = $stmt->fetch();
                    $gambar = $current_product['gambar'];

                    // Handle image upload untuk UPDATE PRODUCT
                    if (isset($_FILES['gambar']) && $_FILES['gambar']['error'] == 0) {
                        $allowed = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                        $filename = $_FILES['gambar']['name'];
                        $filetype = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

                        if (in_array($filetype, $allowed)) {
                            $newname = 'product_' . time() . '_' . uniqid() . '.' . $filetype;
                            $upload_path = '../assets/img/pupuk/' . $newname;

                            if (move_uploaded_file($_FILES['gambar']['tmp_name'], $upload_path)) {
                                // Delete old image
                                if ($gambar && file_exists('../assets/img/pupuk/' . $gambar)) {
                                    unlink('../assets/img/pupuk/' . $gambar);
                                }

                                $gambar = $newname;
                                resizeImage($upload_path, 800, 600);
                            }
                        }
                    }

                    try {
                        $stmt = $pdo->prepare("UPDATE produk SET nama_produk = ?, kategori_id = ?, brand = ?, jenis_pupuk = ?, berat = ?, harga = ?, stok = ?, deskripsi = ?, manfaat = ?, cara_pakai = ?, gambar = ?, status = ?, is_featured = ? WHERE id = ?");
                        $stmt->execute([$nama_produk, $kategori_id, $brand, $jenis_pupuk, $berat, $harga, $stok, $deskripsi, $manfaat, $cara_pakai, $gambar, $status, $is_featured, $id]);

                        $message = 'Produk berhasil diupdate!';
                        $message_type = 'success';
                    } catch (PDOException $e) {
                        $message = 'Error: ' . $e->getMessage();
                        $message_type = 'danger';
                    }
                    break;

                case 'delete_product':
                    $id = (int)$_POST['id'];

                    try {
                        // Get product image
                        $stmt = $pdo->prepare("SELECT gambar FROM produk WHERE id = ?");
                        $stmt->execute([$id]);
                        $product = $stmt->fetch();

                        // Delete product
                        $stmt = $pdo->prepare("DELETE FROM produk WHERE id = ?");
                        $stmt->execute([$id]);

                        // Delete image file
                        if ($product && $product['gambar'] && file_exists('../assets/img/pupuk/' . $product['gambar'])) {
                            unlink('../assets/img/pupuk/' . $product['gambar']);
                        }

                        $message = 'Produk berhasil dihapus!';
                        $message_type = 'success';
                    } catch (PDOException $e) {
                        $message = 'Error: ' . $e->getMessage();
                        $message_type = 'danger';
                    }
                    break;

                case 'toggle_status':
                    $id = (int)$_POST['id'];
                    $current_status = $_POST['current_status'];
                    $new_status = $current_status === 'active' ? 'inactive' : 'active';

                    try {
                        $stmt = $pdo->prepare("UPDATE produk SET status = ? WHERE id = ?");
                        $stmt->execute([$new_status, $id]);

                        $message = "Status produk berhasil diubah menjadi $new_status!";
                        $message_type = 'success';
                    } catch (PDOException $e) {
                        $message = 'Error: ' . $e->getMessage();
                        $message_type = 'danger';
                    }
                    break;

                case 'toggle_featured':
                    $id = (int)$_POST['id'];
                    $current_featured = (int)$_POST['current_featured'];
                    $new_featured = $current_featured ? 0 : 1;

                    try {
                        $stmt = $pdo->prepare("UPDATE produk SET is_featured = ? WHERE id = ?");
                        $stmt->execute([$new_featured, $id]);

                        $status_text = $new_featured ? 'featured' : 'tidak featured';
                        $message = "Produk berhasil diubah menjadi $status_text!";
                        $message_type = 'success';
                    } catch (PDOException $e) {
                        $message = 'Error: ' . $e->getMessage();
                        $message_type = 'danger';
                    }
                    break;
            }
        }
    }

    // Get categories for dropdown
    $categories_stmt = $pdo->query("SELECT * FROM kategori ORDER BY nama_kategori");
    $categories = $categories_stmt->fetchAll();

    // Get filters
    $search = $_GET['search'] ?? '';
    $jenis_filter = $_GET['jenis'] ?? '';
    $status_filter = $_GET['status'] ?? '';
    $kategori_filter = $_GET['kategori'] ?? '';
    $featured_filter = $_GET['featured'] ?? '';
    $stok_rendah = $_GET['stok_rendah'] ?? '';

    // Build query
    $sql = "SELECT p.*, k.nama_kategori 
            FROM produk p 
            LEFT JOIN kategori k ON p.kategori_id = k.id 
            WHERE 1=1";

    $params = [];

    if ($search) {
        $sql .= " AND (p.nama_produk LIKE ? OR p.brand LIKE ? OR k.nama_kategori LIKE ?)";
        $search_param = "%$search%";
        $params[] = $search_param;
        $params[] = $search_param;
        $params[] = $search_param;
    }

    if ($jenis_filter) {
        $sql .= " AND p.jenis_pupuk = ?";
        $params[] = $jenis_filter;
    }

    if ($status_filter) {
        $sql .= " AND p.status = ?";
        $params[] = $status_filter;
    }

    if ($kategori_filter) {
        $sql .= " AND p.kategori_id = ?";
        $params[] = $kategori_filter;
    }

    if ($featured_filter !== '') {
        $sql .= " AND p.is_featured = ?";
        $params[] = (int)$featured_filter;
    }

    if ($stok_rendah) {
        $sql .= " AND p.stok < 10";
    }

    $sql .= " ORDER BY p.created_at DESC";

    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    $products = $stmt->fetchAll();

    // Function untuk resize image
    function resizeImage($file, $maxWidth, $maxHeight)
    {
        $info = getimagesize($file);
        if (!$info) return false;

        $width = $info[0];
        $height = $info[1];
        $type = $info[2];

        // Calculate new dimensions
        $ratio = min($maxWidth / $width, $maxHeight / $height);
        $newWidth = round($width * $ratio);
        $newHeight = round($height * $ratio);

        // Create image resource
        switch ($type) {
            case IMAGETYPE_JPEG:
                $source = imagecreatefromjpeg($file);
                break;
            case IMAGETYPE_PNG:
                $source = imagecreatefrompng($file);
                break;
            case IMAGETYPE_GIF:
                $source = imagecreatefromgif($file);
                break;
            case IMAGETYPE_WEBP:
                $source = imagecreatefromwebp($file);
                break;
            default:
                return false;
        }

        if (!$source) return false;

        // Create new image
        $destination = imagecreatetruecolor($newWidth, $newHeight);

        // Preserve transparency
        if ($type == IMAGETYPE_PNG || $type == IMAGETYPE_GIF) {
            imagealphablending($destination, false);
            imagesavealpha($destination, true);
            $transparent = imagecolorallocatealpha($destination, 255, 255, 255, 127);
            imagefilledrectangle($destination, 0, 0, $newWidth, $newHeight, $transparent);
        }

        // Resize
        imagecopyresampled($destination, $source, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);

        // Save
        switch ($type) {
            case IMAGETYPE_JPEG:
                imagejpeg($destination, $file, 90);
                break;
            case IMAGETYPE_PNG:
                imagepng($destination, $file, 9);
                break;
            case IMAGETYPE_GIF:
                imagegif($destination, $file);
                break;
            case IMAGETYPE_WEBP:
                imagewebp($destination, $file, 90);
                break;
        }

        // Clean up
        imagedestroy($source);
        imagedestroy($destination);

        return true;
    }
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Produk - Admin PupukKita</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .sidebar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-brand {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            text-decoration: none;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 0;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 0;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
        }

        .main-content {
            margin-left: 250px;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .top-bar {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #28a745, #20c997);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .card-body {
            padding: 1.5rem;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            border-top: none;
            border-bottom: 2px solid #e9ecef;
            color: #495057;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f8f9fa;
        }

        .table td {
            vertical-align: middle;
            padding: 1rem 0.75rem;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-img:hover {
            transform: scale(1.1);
        }

        .alert {
            border-radius: 12px;
            border: none;
            margin-bottom: 2rem;
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
            transform: translateY(-1px);
        }

        .filter-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .action-buttons .btn {
            margin: 0 2px;
            padding: 0.375rem 0.75rem;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            margin-top: 10px;
        }

        /* Detail Modal Styles */
        #detailProductModal .modal-dialog {
            max-width: 1000px;
        }

        #detailProductModal .table td {
            padding: 0.5rem 0;
            border: none;
        }

        #detailProductModal .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
        }

        #detailProductModal .nav-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-radius: 5px;
        }

        #detailProductModal .tab-content {
            min-height: 120px;
        }

        #detailProductModal .tab-pane p {
            line-height: 1.6;
        }

        .detail-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }

        .detail-image-container img {
            transition: transform 0.3s ease;
        }

        .detail-image-container:hover img {
            transform: scale(1.05);
        }


        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .top-bar {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #28a745;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #20c997;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.php" class="sidebar-brand">
                <i class="fas fa-leaf me-2"></i>
                Sahabat Tani
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="dashboard.php" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="orders.php" class="nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    Kelola Pesanan
                </a>
            </div>
            <div class="nav-item">
                <a href="products.php" class="nav-link active">
                    <i class="fas fa-box"></i>
                    Kelola Produk
                </a>
            </div>
            <div class="nav-item">
                <a href="promo_codes.php" class="nav-link">
                    <i class="fas fa-tags"></i>
                    Kode Promo
                </a>
            </div>
            <div class="nav-item">
                <a href="reports.php" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    Laporan
                </a>
            </div>
            <div class="nav-item">
                <a href="users.php" class="nav-link">
                    <i class="fas fa-cog"></i>
                    Pengaturan Akun
                </a>
            </div>
            <div class="nav-item mt-4">
                <a href="../logout.php" class="nav-link text-danger">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar animate-fade-in">
            <div>
                <h2 class="mb-0"><i class="fas fa-box me-2"></i>Kelola Produk</h2>
                <small class="text-muted">Kelola semua produk pupuk</small>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus me-2"></i>Tambah Produk
            </button>
        </div>

        <!-- Alert Messages -->
        <?php if ($message): ?>
            <div class="alert alert-<?php echo $message_type; ?> alert-dismissible fade show animate-fade-in" role="alert">
                <i class="fas fa-<?php echo $message_type === 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2"></i>
                <?php echo $message; ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <?php endif; ?>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card animate-fade-in">
                    <div class="stats-icon bg-primary bg-opacity-10 text-primary">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stats-number"><?php echo count($products); ?></div>
                    <div class="stats-label">Total Produk</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card animate-fade-in">
                    <div class="stats-icon bg-success bg-opacity-10 text-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-number">
                        <?php echo count(array_filter($products, function ($p) {
                            return $p['status'] === 'active';
                        })); ?>
                    </div>
                    <div class="stats-label">Produk Aktif</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card animate-fade-in">
                    <div class="stats-icon bg-warning bg-opacity-10 text-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stats-number">
                        <?php echo count(array_filter($products, function ($p) {
                            return $p['stok'] < 10;
                        })); ?>
                    </div>
                    <div class="stats-label">Stok Rendah</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card animate-fade-in">
                    <div class="stats-icon bg-info bg-opacity-10 text-info">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stats-number">
                        <?php echo count(array_filter($products, function ($p) {
                            return $p['is_featured'];
                        })); ?>
                    </div>
                    <div class="stats-label">Featured</div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section animate-fade-in">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Pencarian</label>
                    <input type="text" class="form-control" name="search" value="<?php echo htmlspecialchars($search); ?>" placeholder="Cari produk...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Jenis Pupuk</label>
                    <select class="form-select" name="jenis">
                        <option value="">Semua Jenis</option>
                        <option value="organik" <?php echo $jenis_filter === 'organik' ? 'selected' : ''; ?>>Organik</option>
                        <option value="anorganik" <?php echo $jenis_filter === 'anorganik' ? 'selected' : ''; ?>>Anorganik</option>
                        <option value="hayati" <?php echo $jenis_filter === 'hayati' ? 'selected' : ''; ?>>Hayati</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="">Semua Status</option>
                        <option value="active" <?php echo $status_filter === 'active' ? 'selected' : ''; ?>>Active</option>
                        <option value="inactive" <?php echo $status_filter === 'inactive' ? 'selected' : ''; ?>>Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Kategori</label>
                    <select class="form-select" name="kategori">
                        <option value="">Semua Kategori</option>
                        <?php foreach ($categories as $cat): ?>
                            <option value="<?php echo $cat['id']; ?>" <?php echo $kategori_filter == $cat['id'] ? 'selected' : ''; ?>>
                                <?php echo htmlspecialchars($cat['nama_kategori']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Featured</label>
                    <select class="form-select" name="featured">
                        <option value="">Semua</option>
                        <option value="1" <?php echo $featured_filter === '1' ? 'selected' : ''; ?>>Featured</option>
                        <option value="0" <?php echo $featured_filter === '0' ? 'selected' : ''; ?>>Not Featured</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>

            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="btn-group" role="group">
                        <a href="?stok_rendah=1" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-exclamation-triangle me-1"></i>Stok Rendah
                        </a>
                        <a href="?" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-refresh me-1"></i>Reset Filter
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card animate-fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Daftar Produk</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Gambar</th>
                                <th>Nama Produk</th>
                                <th>Kategori</th>
                                <th>Brand</th>
                                <th>Jenis</th>
                                <th>Berat</th>
                                <th>Harga</th>
                                <th>Stok</th>
                                <th>Status</th>
                                <th>Featured</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($products)): ?>
                                <tr>
                                    <td colspan="11" class="text-center py-5">
                                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                        <p class="text-muted mb-0">Tidak ada produk ditemukan</p>
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php foreach ($products as $product): ?>
                                    <tr>
                                        <td>
                                            <?php if ($product['gambar']): ?>
                                                <img src="../assets/img/pupuk/<?php echo htmlspecialchars($product['gambar']); ?>"
                                                    alt="<?php echo htmlspecialchars($product['nama_produk']); ?>"
                                                    class="product-img"
                                                    onclick="zoomImage('../assets/img/pupuk/<?php echo htmlspecialchars($product['gambar']); ?>', '<?php echo htmlspecialchars($product['nama_produk']); ?>')">
                                            <?php else: ?>
                                                <div class="product-img bg-light d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <strong><?php echo htmlspecialchars($product['nama_produk']); ?></strong>
                                            <br>
                                            <small class="text-muted">ID: <?php echo $product['id']; ?></small>
                                        </td>
                                        <td><?php echo htmlspecialchars($product['nama_kategori'] ?? 'Tidak ada'); ?></td>
                                        <td><?php echo htmlspecialchars($product['brand'] ?? '-'); ?></td>
                                        <td>
                                            <span class="badge bg-<?php echo $product['jenis_pupuk'] === 'organik' ? 'success' : ($product['jenis_pupuk'] === 'anorganik' ? 'primary' : 'info'); ?>">
                                                <?php echo ucfirst($product['jenis_pupuk']); ?>
                                            </span>
                                        </td>
                                        <td><?php echo htmlspecialchars($product['berat']); ?></td>
                                        <td>Rp <?php echo number_format($product['harga'], 0, ',', '.'); ?></td>
                                        <td>
                                            <span class="badge bg-<?php echo $product['stok'] < 10 ? 'danger' : ($product['stok'] < 50 ? 'warning' : 'success'); ?>">
                                                <?php echo $product['stok']; ?>
                                            </span>
                                        </td>
                                        <td>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_status">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <input type="hidden" name="current_status" value="<?php echo $product['status']; ?>">
                                                <button type="submit" class="btn btn-sm btn-<?php echo $product['status'] === 'active' ? 'success' : 'secondary'; ?>"
                                                    onclick="return confirm('Yakin ingin mengubah status produk ini?')">
                                                    <?php echo ucfirst($product['status']); ?>
                                                </button>
                                            </form>
                                        </td>
                                        <td>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_featured">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <input type="hidden" name="current_featured" value="<?php echo $product['is_featured']; ?>">
                                                <button type="submit" class="btn btn-sm btn-<?php echo $product['is_featured'] ? 'warning' : 'outline-warning'; ?>">
                                                    <i class="fas fa-star"></i>
                                                </button>
                                            </form>
                                        </td>
                                        <td class="action-buttons">
                                            <button class="btn btn-info btn-sm"
                                                onclick="viewProduct(<?php echo htmlspecialchars(json_encode($product)); ?>)"
                                                title="Lihat Detail">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm"
                                                onclick="editProduct(<?php echo htmlspecialchars(json_encode($product)); ?>)"
                                                title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="POST" style="display: inline;"
                                                onsubmit="return confirm('Yakin ingin menghapus produk ini? Data tidak dapat dikembalikan!')">
                                                <input type="hidden" name="action" value="delete_product">
                                                <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                                <button type="submit" class="btn btn-danger btn-sm" title="Hapus">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Tambah Produk Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_product">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Produk *</label>
                                    <input type="text" class="form-control" name="nama_produk" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" name="brand">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" name="kategori_id">
                                        <option value="">Pilih Kategori</option>
                                        <?php foreach ($categories as $cat): ?>
                                            <option value="<?php echo $cat['id']; ?>"><?php echo htmlspecialchars($cat['nama_kategori']); ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Pupuk *</label>
                                    <select class="form-select" name="jenis_pupuk" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="organik">Organik</option>
                                        <option value="anorganik">Anorganik</option>
                                        <option value="hayati">Hayati</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Berat *</label>
                                    <input type="text" class="form-control" name="berat" placeholder="contoh: 25kg, 1L" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Harga *</label>
                                    <input type="number" class="form-control" name="harga" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stok *</label>
                                    <input type="number" class="form-control" name="stok" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" required>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Gambar Produk</label>
                            <input type="file" class="form-control" name="gambar" accept="image/*" onchange="previewImage(this, 'addPreview')">
                            <div id="addPreview" class="mt-2"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" name="deskripsi" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Manfaat</label>
                            <textarea class="form-control" name="manfaat" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cara Pakai</label>
                            <textarea class="form-control" name="cara_pakai" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="addFeatured">
                                <label class="form-check-label" for="addFeatured">
                                    Jadikan produk unggulan (Featured)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Simpan Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Detail Product Modal -->
    <div class="modal fade" id="detailProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye"></i> Detail Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <div id="detailImageContainer" class="text-center">
                                <img id="detailImage" src="" alt="" class="img-fluid rounded" style="max-height: 300px;">
                                <div id="detailNoImage" class="bg-light p-5 rounded" style="display: none;">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                    <p class="mt-2 text-muted">Tidak ada gambar</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-7">
                            <h3 id="detailNamaProduk" class="mb-3"></h3>

                            <div class="mb-3">
                                <span id="detailJenisBadge" class="badge me-2"></span>
                                <span id="detailFeaturedBadge" class="badge bg-warning" style="display: none;">
                                    <i class="fas fa-star"></i> Featured
                                </span>
                            </div>

                            <table class="table table-borderless">
                                <tr>
                                    <td width="30%"><strong>ID Produk:</strong></td>
                                    <td id="detailId"></td>
                                </tr>
                                <tr>
                                    <td><strong>Brand:</strong></td>
                                    <td id="detailBrand"></td>
                                </tr>
                                <tr>
                                    <td><strong>Kategori:</strong></td>
                                    <td id="detailKategori"></td>
                                </tr>
                                <tr>
                                    <td><strong>Berat:</strong></td>
                                    <td id="detailBerat"></td>
                                </tr>
                                <tr>
                                    <td><strong>Harga:</strong></td>
                                    <td>
                                        <h4 class="text-success mb-0" id="detailHarga"></h4>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Stok:</strong></td>
                                    <td><span id="detailStokBadge" class="badge"></span></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span id="detailStatusBadge" class="badge"></span></td>
                                </tr>
                                <tr>
                                    <td><strong>Dibuat:</strong></td>
                                    <td id="detailCreated"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="detail-description-tab" data-bs-toggle="tab"
                                        data-bs-target="#detail-description" type="button" role="tab">
                                        <i class="fas fa-info-circle"></i> Deskripsi
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="detail-benefits-tab" data-bs-toggle="tab"
                                        data-bs-target="#detail-benefits" type="button" role="tab">
                                        <i class="fas fa-leaf"></i> Manfaat
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="detail-usage-tab" data-bs-toggle="tab"
                                        data-bs-target="#detail-usage" type="button" role="tab">
                                        <i class="fas fa-instructions"></i> Cara Pakai
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content mt-3" id="detailTabsContent">
                                <div class="tab-pane fade show active" id="detail-description" role="tabpanel">
                                    <div class="p-3 bg-light rounded">
                                        <p id="detailDeskripsi" class="mb-0"></p>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="detail-benefits" role="tabpanel">
                                    <div class="p-3 bg-light rounded">
                                        <p id="detailManfaat" class="mb-0"></p>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="detail-usage" role="tabpanel">
                                    <div class="p-3 bg-light rounded">
                                        <p id="detailCaraPakai" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                    <button type="button" class="btn btn-warning" onclick="editProductFromDetail()">
                        <i class="fas fa-edit"></i> Edit Produk
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="update_product">
                        <input type="hidden" name="id" id="editId">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Produk *</label>
                                    <input type="text" class="form-control" name="nama_produk" id="editNamaProduk" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" name="brand" id="editBrand">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" name="kategori_id" id="editKategori">
                                        <option value="">Pilih Kategori</option>
                                        <?php foreach ($categories as $cat): ?>
                                            <option value="<?php echo $cat['id']; ?>"><?php echo htmlspecialchars($cat['nama_kategori']); ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Pupuk *</label>
                                    <select class="form-select" name="jenis_pupuk" id="editJenisPupuk" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="organik">Organik</option>
                                        <option value="anorganik">Anorganik</option>
                                        <option value="hayati">Hayati</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Berat *</label>
                                    <input type="text" class="form-control" name="berat" id="editBerat" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Harga *</label>
                                    <input type="number" class="form-control" name="harga" id="editHarga" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stok *</label>
                                    <input type="number" class="form-control" name="stok" id="editStok" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" id="editStatus" required>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Gambar Produk</label>
                            <input type="file" class="form-control" name="gambar" accept="image/*" onchange="previewImage(this, 'editPreview')">
                            <div id="editPreview" class="mt-2"></div>
                            <small class="text-muted">Kosongkan jika tidak ingin mengubah gambar</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" name="deskripsi" id="editDeskripsi" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Manfaat</label>
                            <textarea class="form-control" name="manfaat" id="editManfaat" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cara Pakai</label>
                            <textarea class="form-control" name="cara_pakai" id="editCaraPakai" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="editFeatured">
                                <label class="form-check-label" for="editFeatured">
                                    Jadikan produk unggulan (Featured)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save me-2"></i>Update Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div class="modal fade" id="imageZoomModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageZoomTitle">Gambar Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="imageZoomSrc" src="" alt="" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function untuk preview image
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Function untuk view detail produk
        function viewProduct(product) {
            // Set basic info
            document.getElementById('detailId').textContent = product.id;
            document.getElementById('detailNamaProduk').textContent = product.nama_produk || '-';
            document.getElementById('detailBrand').textContent = product.brand || '-';
            document.getElementById('detailKategori').textContent = product.nama_kategori || 'Tidak ada kategori';
            document.getElementById('detailBerat').textContent = product.berat || '-';
            document.getElementById('detailHarga').textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(product.harga || 0);
            document.getElementById('detailCreated').textContent = product.created_at ? new Date(product.created_at).toLocaleDateString('id-ID') : '-';

            // Set jenis pupuk badge
            const jenisBadge = document.getElementById('detailJenisBadge');
            jenisBadge.textContent = product.jenis_pupuk ? product.jenis_pupuk.charAt(0).toUpperCase() + product.jenis_pupuk.slice(1) : '-';
            jenisBadge.className = 'badge me-2 bg-' + (
                product.jenis_pupuk === 'organik' ? 'success' :
                product.jenis_pupuk === 'anorganik' ? 'primary' : 'info'
            );

            // Set featured badge
            const featuredBadge = document.getElementById('detailFeaturedBadge');
            featuredBadge.style.display = product.is_featured == 1 ? 'inline-block' : 'none';

            // Set stok badge
            const stokBadge = document.getElementById('detailStokBadge');
            stokBadge.textContent = (product.stok || 0) + ' tersedia';
            stokBadge.className = 'badge bg-' + (
                product.stok < 10 ? 'danger' :
                product.stok < 50 ? 'warning' : 'success'
            );

            // Set status badge
            const statusBadge = document.getElementById('detailStatusBadge');
            statusBadge.textContent = product.status ? product.status.charAt(0).toUpperCase() + product.status.slice(1) : '-';
            statusBadge.className = 'badge bg-' + (product.status === 'active' ? 'success' : 'secondary');

            // Set image
            const detailImage = document.getElementById('detailImage');
            const detailNoImage = document.getElementById('detailNoImage');

            if (product.gambar) {
                detailImage.src = '../assets/img/pupuk/' + product.gambar;
                detailImage.alt = product.nama_produk;
                detailImage.style.display = 'block';
                detailNoImage.style.display = 'none';
            } else {
                detailImage.style.display = 'none';
                detailNoImage.style.display = 'block';
            }

            // Set descriptions
            document.getElementById('detailDeskripsi').innerHTML = product.deskripsi ?
                product.deskripsi.replace(/\n/g, '<br>') :
                '<em class="text-muted">Tidak ada deskripsi tersedia</em>';

            document.getElementById('detailManfaat').innerHTML = product.manfaat ?
                product.manfaat.replace(/\n/g, '<br>') :
                '<em class="text-muted">Tidak ada informasi manfaat tersedia</em>';

            document.getElementById('detailCaraPakai').innerHTML = product.cara_pakai ?
                product.cara_pakai.replace(/\n/g, '<br>') :
                '<em class="text-muted">Tidak ada informasi cara pakai tersedia</em>';

            // Store product data for edit function
            window.currentDetailProduct = product;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('detailProductModal'));
            modal.show();
        }

        // Function untuk edit dari detail modal
        function editProductFromDetail() {
            if (window.currentDetailProduct) {
                // Close detail modal first
                const detailModal = bootstrap.Modal.getInstance(document.getElementById('detailProductModal'));
                detailModal.hide();

                // Wait a bit then open edit modal
                setTimeout(() => {
                    editProduct(window.currentDetailProduct);
                }, 300);
            }
        }


        // Function untuk edit produk
        function editProduct(product) {
            // Populate form fields
            document.getElementById('editId').value = product.id;
            document.getElementById('editNamaProduk').value = product.nama_produk || '';
            document.getElementById('editBrand').value = product.brand || '';
            document.getElementById('editKategori').value = product.kategori_id || '';
            document.getElementById('editJenisPupuk').value = product.jenis_pupuk || '';
            document.getElementById('editBerat').value = product.berat || '';
            document.getElementById('editHarga').value = product.harga || '';
            document.getElementById('editStok').value = product.stok || '';
            document.getElementById('editStatus').value = product.status || '';
            document.getElementById('editDeskripsi').value = product.deskripsi || '';
            document.getElementById('editManfaat').value = product.manfaat || '';
            document.getElementById('editCaraPakai').value = product.cara_pakai || '';
            document.getElementById('editFeatured').checked = product.is_featured == 1;

            // Show current image if exists
            const editPreview = document.getElementById('editPreview');
            editPreview.innerHTML = '';
            if (product.gambar) {
                const img = document.createElement('img');
                img.src = '../assets/img/pupuk/' + product.gambar;
                img.className = 'preview-image';
                img.alt = 'Current Image';
                editPreview.appendChild(img);

                const label = document.createElement('p');
                label.className = 'small text-muted mt-2';
                label.textContent = 'Gambar saat ini';
                editPreview.appendChild(label);
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        }

        // Function untuk zoom image
        function zoomImage(src, alt) {
            document.getElementById('imageZoomSrc').src = src;
            document.getElementById('imageZoomSrc').alt = alt;
            document.getElementById('imageZoomTitle').textContent = alt;

            const modal = new bootstrap.Modal(document.getElementById('imageZoomModal'));
            modal.show();
        }

        // Auto-hide alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });

        // Format currency input
        document.addEventListener('DOMContentLoaded', function() {
            const hargaInputs = document.querySelectorAll('input[name="harga"]');
            hargaInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    // Remove non-numeric characters except decimal point
                    this.value = this.value.replace(/[^0-9.]/g, '');

                    // Ensure only one decimal point
                    const parts = this.value.split('.');
                    if (parts.length > 2) {
                        this.value = parts[0] + '.' + parts.slice(1).join('');
                    }
                });
            });
        });

        // Search with debounce
        let searchTimeout;

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                document.querySelector('form').submit();
            }, 500);
        }

        // Add event listener to search input
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput) {
                searchInput.addEventListener('input', debounceSearch);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + N = New Product
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
                modal.show();
            }

            // Escape = Close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(function(modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
            }
        });

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form[method="POST"]');
            forms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    const requiredFields = form.querySelectorAll('[required]');
                    let isValid = true;

                    requiredFields.forEach(function(field) {
                        if (!field.value.trim()) {
                            field.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        alert('Mohon lengkapi semua field yang wajib diisi!');
                    }
                });
            });
        });

        // Real-time validation
        document.addEventListener('DOMContentLoaded', function() {
            const requiredInputs = document.querySelectorAll('input[required], select[required], textarea[required]');

            requiredInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                    }
                });

                input.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.classList.remove('is-invalid');
                    }
                });
            });
        });

        // Add error handling to product images
        document.addEventListener('DOMContentLoaded', function() {
            const productImages = document.querySelectorAll('.product-img');
            productImages.forEach(img => {
                img.addEventListener('error', function() {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0xNSAxNUgzNVYzNUgxNVYxNVoiIGZpbGw9IiNEQ0RDREMiLz4KPC9zdmc+';
                    this.alt = 'Gambar tidak tersedia';
                });
            });
        });

        // Enhanced mobile responsiveness
        function handleMobileView() {
            const isMobile = window.innerWidth <= 768;
            const sidebar = document.querySelector('.sidebar');

            if (isMobile) {
                sidebar.style.transform = 'translateX(-100%)';
            } else {
                sidebar.style.transform = 'translateX(0)';
            }
        }

        // Handle window resize
        window.addEventListener('resize', handleMobileView);
        document.addEventListener('DOMContentLoaded', handleMobileView);

        // Add loading state to buttons
        document.addEventListener('DOMContentLoaded', function() {
            const submitButtons = document.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
                    this.disabled = true;

                    // Re-enable button after 3 seconds (fallback)
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 3000);
                });
            });
        });

        // Add confirmation for bulk actions
        function confirmBulkAction(action, count) {
            const actions = {
                'delete': 'menghapus',
                'activate': 'mengaktifkan',
                'deactivate': 'menonaktifkan',
                'feature': 'menjadikan featured',
                'unfeature': 'menghapus dari featured'
            };

            return confirm(`Yakin ingin ${actions[action]} ${count} produk yang dipilih?`);
        }

        // Enhanced table sorting
        function sortTable(column, order) {
            const url = new URL(window.location);
            url.searchParams.set('sort', column);
            url.searchParams.set('order', order);
            window.location.href = url.toString();
        }

        // Add smooth scrolling to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Show scroll to top button
        window.addEventListener('scroll', function() {
            const scrollBtn = document.getElementById('scrollToTop');
            if (scrollBtn) {
                if (window.pageYOffset > 300) {
                    scrollBtn.style.display = 'block';
                } else {
                    scrollBtn.style.display = 'none';
                }
            }
        });

        // Add tooltips to action buttons
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
        });

        // Add print functionality
        function printTable() {
            const printContent = document.querySelector('.table-responsive').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Daftar Produk - PupukKita</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .btn { display: none; }
                            .product-img { width: 30px; height: 30px; }
                        </style>
                    </head>
                    <body>
                        <h2>Daftar Produk - PupukKita</h2>
                        <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Add export functionality
        function exportToCSV() {
            const table = document.querySelector('.table');
            const rows = table.querySelectorAll('tr');
            let csv = [];

            for (let i = 0; i < rows.length; i++) {
                const row = [],
                    cols = rows[i].querySelectorAll('td, th');

                for (let j = 0; j < cols.length - 1; j++) { // Exclude action column
                    let cellText = cols[j].innerText.replace(/"/g, '""');
                    row.push('"' + cellText + '"');
                }
                csv.push(row.join(','));
            }

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `produk_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Add notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Add drag and drop for image upload
        function setupDragAndDrop() {
            const fileInputs = document.querySelectorAll('input[type="file"]');

            fileInputs.forEach(input => {
                const dropZone = input.parentElement;

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });

                dropZone.addEventListener('drop', handleDrop, false);

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                function highlight(e) {
                    dropZone.classList.add('border-primary', 'bg-light');
                }

                function unhighlight(e) {
                    dropZone.classList.remove('border-primary', 'bg-light');
                }

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;

                    if (files.length > 0) {
                        input.files = files;
                        const event = new Event('change', {
                            bubbles: true
                        });
                        input.dispatchEvent(event);
                    }
                }
            });
        }

        // Initialize drag and drop when modals are shown
        document.addEventListener('DOMContentLoaded', function() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('shown.bs.modal', setupDragAndDrop);
            });
        });
    </script>

    <!-- Scroll to Top Button -->
    <button id="scrollToTop" onclick="scrollToTop()"
        style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 999; 
                   background: linear-gradient(135deg, #28a745, #20c997); color: white; 
                   border: none; border-radius: 50%; width: 50px; height: 50px; 
                   box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s ease;"
        onmouseover="this.style.transform='scale(1.1)'"
        onmouseout="this.style.transform='scale(1)'">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Additional CSS for enhanced styling -->
    <style>
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(40, 167, 69, 0.05) !important;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-content {
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .badge {
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .stats-card {
            cursor: pointer;
        }

        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            margin: 0 10px;
        }

        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin: 0 10px;
        }

        .table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .top-bar {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .stats-number {
                font-size: 1.8rem;
            }

            .table-responsive {
                font-size: 0.875rem;
            }

            .action-buttons .btn {
                padding: 0.25rem 0.5rem;
                margin: 1px;
            }

            .filter-section .row {
                gap: 0.5rem;
            }
        }

        /* Loading animation */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        /* Enhanced hover effects */
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .card:hover .card-header {
            background: linear-gradient(135deg, #f1f3f4, #e8eaed);
        }

        /* Improved form styling */
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .form-control,
        .form-select {
            border: 1.5px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .form-control:hover,
        .form-select:hover {
            border-color: #28a745;
        }

        /* Better spacing */
        .mb-3 {
            margin-bottom: 1.5rem !important;
        }

        .mt-3 {
            margin-top: 1.5rem !important;
        }
    </style>
</body>

</html>